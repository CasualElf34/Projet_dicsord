<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Likoo</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
</head>
<body data-theme="amber">

<!-- CUSTOM TITLEBAR (Electron) -->
<div id="titlebar" class="titlebar">
  <div class="titlebar-left">
    <span class="titlebar-logo">Likoo</span>
    <span class="titlebar-sep">|</span>
    <span class="titlebar-location" id="titlebarLocation">Accueil</span>
  </div>
  <div class="titlebar-right">
    <button id="minBtn" class="win-btn" title="Minimiser">â€”</button>
    <button id="maxBtn" class="win-btn" title="Maximiser">â–¡</button>
    <button id="closeBtn" class="win-btn" title="Fermer">âœ•</button>
  </div>
</div>

<!-- TOP NAV -->
<div class="topnav">
  <div class="logo" onclick="showHome()">Likoo</div>
  <div class="nav-servers" id="navServers"></div>
  <div class="nav-sep"></div>
  <div class="nav-add" onclick="openModal('modalCreateServer')">+ Serveur</div>
  <div class="nav-sep"></div>
  <div class="nav-profile">
    <div class="nav-av" id="navAv" onclick="openSettings()">
      <div class="st-dot online" id="navStatusDot"></div>
    </div>
    <div class="nav-username" id="navName">â€”</div>
    <button class="nav-btn" onclick="toggleBtn(this)" title="Micro">ğŸ™</button>
    <button class="nav-btn" onclick="toggleBtn(this)" title="Casque">ğŸ§</button>
    <button class="nav-btn settings-btn" onclick="openSettings()" title="ParamÃ¨tres">âš™</button>
  </div>
</div>

<!-- WORKSPACE â€” 3 zones -->
<div class="workspace" id="workspace">

  <!-- ZONE LEFT -->
  <div class="zone zone-left" id="zoneLeft" ondragover="onZoneDragOver(event,'left')" ondragleave="onZoneDragLeave(event,'left')" ondrop="onZoneDrop(event,'left')">
    <!-- channels by default -->
    <div class="module" id="mod-channels" draggable="true" ondragstart="onModDragStart(event,'mod-channels')" ondragend="onModDragEnd()">
      <div class="module-header">
        <span class="drag-handle">â‹®â‹®</span>
        <span class="module-icon" id="chModIcon">#</span>
        <span class="module-title" id="chModTitle">Salons</span>
      </div>
      <div class="search-bar"><span>ğŸ”</span><input type="text" placeholder="Rechercherâ€¦"></div>
      <div class="channels-scroll" id="channelsList"></div>
      <div class="user-dock" id="userDock"></div>
    </div>
  </div>

  <!-- ZONE CENTER -->
  <div class="zone zone-center" id="zoneCenter">
    <!-- chat by default -->
    <div class="module" id="mod-chat" draggable="true" ondragstart="onModDragStart(event,'mod-chat')" ondragend="onModDragEnd()">
      <!-- Chat topbar -->
      <div class="chat-topbar">
        <span class="chat-icon" id="chatIcon">#</span>
        <span class="chat-name" id="chatName">Likoo</span>
        <span class="chat-desc" id="chatDesc"></span>
        <div class="topbar-btns">
          <button class="topbar-btn">ğŸ“Œ</button>
          <button class="topbar-btn" onclick="toggleMembers()">ğŸ‘¥</button>
        </div>
      </div>
      <!-- Messages -->
      <div class="messages" id="messages">
        <div class="empty-chat">
          <div class="big">ğŸ’¬</div>
          <h3>Bienvenue sur Likoo</h3>
          <p style="font-size:13px">Rejoignez un serveur ou dÃ©marrez une conversation âœ¨</p>
        </div>
      </div>
      <!-- Input -->
      <div class="input-area">
        <div class="emoji-picker" id="emojiPicker"></div>
        <div class="typing-hint" id="typingHint"></div>
        <div class="input-box">
          <button class="inp-btn" onclick="document.getElementById('fileIn').click()">ğŸ“</button>
          <input type="file" id="fileIn" style="display:none" onchange="handleFile(this)">
          <textarea id="msgInput" rows="1" placeholder="Messageâ€¦" onkeydown="handleKey(event)" oninput="autoResize(this);simTyping()"></textarea>
          <button class="inp-btn" onclick="toggleEmoji()">ğŸ˜Š</button>
          <button class="send-btn" onclick="sendMsg()">â¤</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ZONE RIGHT -->
  <div class="zone zone-right" id="zoneRight" ondragover="onZoneDragOver(event,'right')" ondragleave="onZoneDragLeave(event,'right')" ondrop="onZoneDrop(event,'right')">
    <!-- members by default -->
    <div class="module" id="mod-members" draggable="true" ondragstart="onModDragStart(event,'mod-members')" ondragend="onModDragEnd()">
      <div class="module-header">
        <span class="drag-handle">â‹®â‹®</span>
        <span class="module-icon">ğŸ‘¥</span>
        <span class="module-title">Membres</span>
      </div>
      <div class="members-scroll" id="membersList"></div>
    </div>
  </div>

</div>

<!-- MOBILE BOTTOM NAV -->
<div id="mob-nav">
  <button class="mob-tab active" id="mobTabSrv" onclick="mobSwitch('servers')">ğŸ <span>Serveurs</span></button>
  <button class="mob-tab" id="mobTabCh" onclick="mobSwitch('channels')">â˜°<span>Salons</span></button>
  <button class="mob-tab" id="mobTabChat" onclick="mobSwitch('chat')">ğŸ’¬<span>Chat</span></button>
  <button class="mob-tab" id="mobTabMem" onclick="mobSwitch('members')">ğŸ‘¥<span>Membres</span></button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Setup -->
<div class="overlay" id="modalSetup">
  <div class="modal">
    <h2>Bienvenue sur Likoo ğŸ‘‹</h2>
    <p class="sub">CrÃ©ez votre profil pour rejoindre la discussion.</p>
    <input type="text" id="setupName" placeholder="Ton nom d'affichage" maxlength="32">
    <input type="text" id="setupTag" placeholder="Tag numÃ©rique (ex: 1234)" maxlength="4">
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="setupAccount()">Entrer dans Likoo ğŸš€</button>
    </div>
  </div>
</div>

<!-- Create Server -->
<div class="overlay" id="modalCreateServer">
  <div class="modal">
    <h2>CrÃ©er un serveur âœ¨</h2>
    <p class="sub">Donnez un nom et une ambiance Ã  votre communautÃ©.</p>
    <input type="text" id="srvName" placeholder="Nom du serveur" maxlength="32">
    <input type="text" id="srvEmoji" placeholder="Emoji (ex: ğŸ® ğŸµ ğŸ¨)" maxlength="2">
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalCreateServer')">Annuler</button>
      <button class="btn btn-primary" onclick="createServer()">CrÃ©er</button>
    </div>
  </div>
</div>

<!-- Create Channel -->
<div class="overlay" id="modalCreateChannel">
  <div class="modal">
    <h2>Nouveau salon</h2>
    <p class="sub">Ajoutez un salon Ã  votre serveur.</p>
    <input type="text" id="newChName" placeholder="nom-du-salon" maxlength="32">
    <div class="chip-row">
      <div class="chip sel" data-type="text" onclick="selChType(this)">ğŸ’¬ Texte</div>
      <div class="chip" data-type="voice" onclick="selChType(this)">ğŸ”Š Vocal</div>
      <div class="chip" data-type="announce" onclick="selChType(this)">ğŸ“¢ Annonces</div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalCreateChannel')">Annuler</button>
      <button class="btn btn-primary" onclick="createChannel()">CrÃ©er</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SETTINGS MODAL â€” ParamÃ¨tres complets
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="modalSettings">
  <div class="modal" style="max-width:560px">
    <h2>ParamÃ¨tres âš™</h2>
    <p class="sub">Personnalisez Likoo Ã  votre goÃ»t.</p>

    <!-- Profil -->
    <div class="settings-section">
      <h3>ğŸ™‹ Mon profil</h3>
      <input type="text" id="setName" placeholder="Nom d'affichage">
      <div style="margin-bottom:10px">
        <div style="font-size:11px;font-weight:700;color:var(--text4);margin-bottom:7px">STATUT</div>
        <div class="status-row" id="statusRow">
          <div class="st-chip active" data-status="online" onclick="setStatus(this)">ğŸŸ¢ En ligne</div>
          <div class="st-chip" data-status="away" onclick="setStatus(this)">ğŸŸ¡ Absent</div>
          <div class="st-chip" data-status="dnd" onclick="setStatus(this)">ğŸ”´ Ne pas dÃ©ranger</div>
          <div class="st-chip" data-status="offline" onclick="setStatus(this)">âš« Invisible</div>
        </div>
      </div>
    </div>

    <!-- ThÃ¨mes -->
    <div class="settings-section">
      <h3>ğŸ¨ ThÃ¨me de couleurs</h3>
      <div class="theme-grid" id="themeGrid">

        <div class="theme-card active" data-theme="amber" onclick="applyTheme(this)">
          <div class="theme-preview">
            <div class="theme-preview-nav" style="background:#5c3d1e"></div>
            <div class="theme-preview-content" style="background:#faf6ef">
              <div class="theme-preview-bar" style="background:#e8850a"></div>
              <div class="theme-preview-msg" style="background:#6b4a28"></div>
              <div class="theme-preview-msg" style="background:#6b4a28;width:55%"></div>
            </div>
          </div>
          <div class="theme-name">Ambre Chaud</div>
        </div>

        <div class="theme-card" data-theme="violet" onclick="applyTheme(this)">
          <div class="theme-preview">
            <div class="theme-preview-nav" style="background:#3b1f6e"></div>
            <div class="theme-preview-content" style="background:#f0edf8">
              <div class="theme-preview-bar" style="background:#8b5cf6"></div>
              <div class="theme-preview-msg" style="background:#4a3a72"></div>
              <div class="theme-preview-msg" style="background:#4a3a72;width:50%"></div>
            </div>
          </div>
          <div class="theme-name">Violet Pastel</div>
        </div>

        <div class="theme-card" data-theme="night" onclick="applyTheme(this)">
          <div class="theme-preview">
            <div class="theme-preview-nav" style="background:#090c14"></div>
            <div class="theme-preview-content" style="background:#0f1117">
              <div class="theme-preview-bar" style="background:#38bdf8"></div>
              <div class="theme-preview-msg" style="background:#64748b"></div>
              <div class="theme-preview-msg" style="background:#64748b;width:60%"></div>
            </div>
          </div>
          <div class="theme-name">Minuit</div>
        </div>

        <div class="theme-card" data-theme="sakura" onclick="applyTheme(this)">
          <div class="theme-preview">
            <div class="theme-preview-nav" style="background:#831843"></div>
            <div class="theme-preview-content" style="background:#fff0f5">
              <div class="theme-preview-bar" style="background:#e879a0"></div>
              <div class="theme-preview-msg" style="background:#be185d"></div>
              <div class="theme-preview-msg" style="background:#be185d;width:45%"></div>
            </div>
          </div>
          <div class="theme-name">Sakura</div>
        </div>

        <div class="theme-card" data-theme="forest" onclick="applyTheme(this)">
          <div class="theme-preview">
            <div class="theme-preview-nav" style="background:#052010"></div>
            <div class="theme-preview-content" style="background:#0d1f13">
              <div class="theme-preview-bar" style="background:#4ade80"></div>
              <div class="theme-preview-msg" style="background:#34d399"></div>
              <div class="theme-preview-msg" style="background:#34d399;width:65%"></div>
            </div>
          </div>
          <div class="theme-name">ForÃªt</div>
        </div>

        <div class="theme-card" data-theme="golden" onclick="applyTheme(this)">
          <div class="theme-preview">
            <div class="theme-preview-nav" style="background:#78350f"></div>
            <div class="theme-preview-content" style="background:#fffbeb">
              <div class="theme-preview-bar" style="background:#d97706"></div>
              <div class="theme-preview-msg" style="background:#78350f"></div>
              <div class="theme-preview-msg" style="background:#78350f;width:55%"></div>
            </div>
          </div>
          <div class="theme-name">DorÃ©</div>
        </div>

      </div>
    </div>

    <!-- Disposition des modules -->
    <div class="settings-section">
      <h3>ğŸ“ Disposition des modules</h3>
      <p style="font-size:12px;color:var(--text4);margin-bottom:10px">Cliquez pour appliquer â€” ou glissez-dÃ©posez les blocs manuellement dans les zones.</p>
      <div class="layout-grid" id="layoutGrid">

        <div class="layout-card active" data-layout="default" onclick="applyLayout(this)">
          <div class="layout-preview">
            <div class="lp-block" style="width:28%"></div>
            <div class="lp-main"></div>
            <div class="lp-block" style="width:24%"></div>
          </div>
          <div class="layout-label">Classique</div>
        </div>

        <div class="layout-card" data-layout="focus" onclick="applyLayout(this)">
          <div class="layout-preview">
            <div class="lp-block" style="width:24%"></div>
            <div class="lp-main"></div>
          </div>
          <div class="layout-label">Focus (sans membres)</div>
        </div>

        <div class="layout-card" data-layout="compact" onclick="applyLayout(this)">
          <div class="layout-preview">
            <div class="lp-block" style="width:20%"></div>
            <div class="lp-main"></div>
            <div class="lp-block" style="width:18%"></div>
          </div>
          <div class="layout-label">Compact</div>
        </div>

        <div class="layout-card" data-layout="wide-chat" onclick="applyLayout(this)">
          <div class="layout-preview">
            <div class="lp-main"></div>
            <div class="lp-block" style="width:28%"></div>
          </div>
          <div class="layout-label">Chat Large</div>
        </div>

        <div class="layout-card" data-layout="reversed" onclick="applyLayout(this)">
          <div class="layout-preview">
            <div class="lp-block" style="width:24%"></div>
            <div class="lp-main"></div>
            <div class="lp-block" style="width:28%"></div>
          </div>
          <div class="layout-label">InversÃ©</div>
        </div>

        <div class="layout-card" data-layout="minimal" onclick="applyLayout(this)">
          <div class="layout-preview">
            <div class="lp-main"></div>
          </div>
          <div class="layout-label">Minimaliste</div>
        </div>

      </div>
    </div>

    <!-- Police -->
    <div class="settings-section">
      <h3>ğŸ”¤ Police d'Ã©criture</h3>
      <div class="font-row">
        <div class="font-chip active" data-font="Plus Jakarta Sans" onclick="applyFont(this)" style="font-family:'Plus Jakarta Sans',sans-serif">Jakarta</div>
        <div class="font-chip" data-font="Georgia" onclick="applyFont(this)" style="font-family:Georgia,serif">Georgia</div>
        <div class="font-chip" data-font="'Courier New'" onclick="applyFont(this)" style="font-family:'Courier New',monospace">Courier</div>
        <div class="font-chip" data-font="Verdana" onclick="applyFont(this)" style="font-family:Verdana,sans-serif">Verdana</div>
      </div>
    </div>

    <!-- Taille du texte -->
    <div class="settings-section">
      <h3>ğŸ”¡ Taille du texte</h3>
      <div class="slider-row">
        <span style="font-size:11px;color:var(--text4)">A</span>
        <input type="range" min="11" max="18" value="13" id="fontSizeSlider" oninput="applyFontSize(this.value)">
        <span style="font-size:16px;color:var(--text4)">A</span>
        <span class="slider-val" id="fontSizeVal">13</span>
      </div>
    </div>

    <!-- Toggles -->
    <div class="settings-section">
      <h3>âš™ PrÃ©fÃ©rences</h3>
      <div class="toggle-row">
        <span class="toggle-label">Animations des messages</span>
        <label class="toggle"><input type="checkbox" checked onchange="toggleAnim(this)"><div class="toggle-track"></div></label>
      </div>
      <div class="toggle-row">
        <span class="toggle-label">Compact (messages groupÃ©s)</span>
        <label class="toggle"><input type="checkbox" onchange="toggleCompact(this)"><div class="toggle-track"></div></label>
      </div>
      <div class="toggle-row">
        <span class="toggle-label">Notifications sonores</span>
        <label class="toggle"><input type="checkbox" checked><div class="toggle-track"></div></label>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalSettings')">Fermer</button>
      <button class="btn btn-primary" onclick="saveSettings()">Sauvegarder</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = {
  me: null,
  servers: [],
  activeSrv: null,
  activeCh: null,
  dmChannel: null,
  view: 'home',
  messages: {},
  inVoice: null,
  theme: 'amber',
  layout: 'default',
  dragMod: null,
  membersVisible: true,
  compact: false,
  anim: true,
};

const COLORS  = ['#e8850a','#8b5cf6','#ec4899','#14b8a6','#3b82f6','#22c55e','#ef4444','#f59e0b'];
const AVATARS = ['ğŸ¦Š','ğŸ‘¾','ğŸ‰','ğŸŒŸ','ğŸ¦','ğŸº','ğŸ¦‹','ğŸ™','ğŸ­','ğŸ¦„','ğŸ»','ğŸ¸'];
const EMOJIS  = ['ğŸ˜€','ğŸ˜‚','â¤ï¸','ğŸ‘','ğŸ‰','ğŸ”¥','âœ¨','ğŸ˜','ğŸ¤”','ğŸ˜…','ğŸ‘€','ğŸ’¯','ğŸš€','ğŸ®','ğŸ’œ','ğŸ˜','ğŸ¤£','ğŸ‘‹','ğŸ’ª','ğŸ¦„','âš¡','ğŸŒŸ','ğŸ˜­','ğŸ¥º','ğŸ¤¯','ğŸ˜','ğŸ¤™','ğŸ’€','ğŸ•','ğŸµ'];

const DEMO_MEMBERS = [
  {name:'Zara', tag:'4521',av:'ğŸ¦Š',color:'#e74c3c',status:'online', role:'Admin'},
  {name:'Nino', tag:'7788',av:'ğŸ‘¾',color:'#3b82f6',status:'online', role:'Membre'},
  {name:'LÃ©a',  tag:'3310',av:'ğŸ¦‹',color:'#22c55e',status:'away',   role:'Membre'},
  {name:'Max',  tag:'9001',av:'ğŸ‰',color:'#f59e0b',status:'dnd',    role:'ModÃ©rateur'},
  {name:'Sofia',tag:'1111',av:'ğŸŒŸ',color:'#9b59b6',status:'offline',role:'Membre'},
  {name:'Kev',  tag:'2222',av:'ğŸ¦',color:'#14b8a6',status:'offline',role:'Membre'},
];
const DEMO_DMS = [
  {id:'dm_zara',...DEMO_MEMBERS[0]},
  {id:'dm_nino',...DEMO_MEMBERS[1]},
  {id:'dm_lea', ...DEMO_MEMBERS[2]},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.onload = function() {
  const saved = localStorage.getItem('likoo_me');
  const savedTheme = localStorage.getItem('likoo_theme');
  const savedLayout = localStorage.getItem('likoo_layout');
  if (savedTheme) applyThemeVal(savedTheme);
  if (savedLayout) applyLayoutVal(savedLayout);
  if (saved) { S.me = JSON.parse(saved); startApp(); }
  else openModal('modalSetup');
  buildEmoji();
};

function startApp() {
  buildDemo();
  renderNav();
  selectServer(S.servers[0].id);
  renderMembers();
  renderUserDock();
  updateNavAv();
}

function buildDemo() {
  const t = now();
  S.servers = [{
    id:'demo', name:'Mon Serveur', emoji:'ğŸ ',
    channels:[
      {id:'gen',   name:'gÃ©nÃ©ral',       type:'text',    desc:'Espace principal',notif:2},
      {id:'intro', name:'introductions', type:'text',    desc:'PrÃ©sentez-vous !'},
      {id:'ann',   name:'annonces',      type:'announce',desc:''},
      {id:'gaming',name:'gaming',        type:'text',    desc:'ğŸ® Jeux vidÃ©o'},
      {id:'music', name:'musique',       type:'text',    desc:'ğŸµ Playlists'},
      {id:'vc1',   name:'Vocal lounge',  type:'voice'},
      {id:'vc2',   name:'Gaming VC',     type:'voice'},
    ],
    members: DEMO_MEMBERS,
  }];
  S.messages['gen'] = [
    {id:1,author:DEMO_MEMBERS[0],content:'Bienvenue sur Likoo ! ğŸ‰ Enfin notre propre espace.',time:t,reactions:[{e:'ğŸ‰',c:3},{e:'â¤ï¸',c:2}]},
    {id:2,author:DEMO_MEMBERS[1],content:'Trop bien ! J\'adore pouvoir dÃ©placer les modules.',time:t,reactions:[]},
    {id:3,author:DEMO_MEMBERS[2],content:'Et les thÃ¨mes en temps rÃ©el c\'est ouf ğŸ‘€',time:t,reactions:[{e:'ğŸ‘€',c:1}]},
    {id:4,author:DEMO_MEMBERS[3],content:'J\'ai invitÃ© tout le monde ğŸ”¥',time:t,reactions:[{e:'ğŸ”¥',c:4}]},
  ];
  S.messages['intro'] = [
    {id:5,author:DEMO_MEMBERS[1],content:'Salut ! Je suis Nino ğŸ®',time:t,reactions:[]},
    {id:6,author:DEMO_MEMBERS[2],content:'Moi c\'est LÃ©a, dev front ğŸ’»',time:t,reactions:[{e:'ğŸ’™',c:1}]},
  ];
  ['gaming','music','ann','vc1','vc2'].forEach(k=>S.messages[k]=[]);
  S.messages['dm_zara']=[{id:7,author:DEMO_MEMBERS[0],content:'Yo ! Tu as vu Likoo ? ğŸ˜',time:t,reactions:[]}];
  S.messages['dm_nino']=[]; S.messages['dm_lea']=[];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACCOUNT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupAccount() {
  const n=q('#setupName').value.trim()||'Utilisateur';
  const t=q('#setupTag').value.replace(/\D/g,'').slice(0,4).padStart(4,'0')||rnd(1000,9999).toString();
  S.me={name:n,tag:t,av:AVATARS[rnd(0,11)],color:COLORS[rnd(0,7)],status:'online'};
  save(); closeModal('modalSetup'); startApp();
}
function save(){localStorage.setItem('likoo_me',JSON.stringify(S.me));}
function updateNavAv(){
  const el=q('#navAv'); if(!el||!S.me)return;
  el.innerHTML=`<span style="font-size:16px">${S.me.av}</span><div class="st-dot ${S.me.status}" id="navStatusDot"></div>`;
  q('#navName').textContent=S.me.name;
}
function renderUserDock(){
  const el=q('#userDock'); if(!el||!S.me)return;
  el.innerHTML=`
    <div class="dock-av" style="background:${S.me.color}20" onclick="openSettings()">
      <span style="font-size:15px">${S.me.av}</span>
      <div class="st-dot ${S.me.status}" id="dockDot"></div>
    </div>
    <div class="dock-info"><div class="dock-name" id="dockName">${S.me.name}</div><div class="dock-tag">#${S.me.tag}</div></div>
    <div class="dock-btns">
      <button class="dock-btn" onclick="toggleBtn(this)" title="Micro">ğŸ™</button>
      <button class="dock-btn" onclick="toggleBtn(this)" title="Casque">ğŸ§</button>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderNav(){
  const el=q('#navServers'); if(!el)return;
  let h=`<div class="nav-server ${S.view==='dm'?'active':''}" onclick="showDM()">ğŸ’¬ Messages privÃ©s</div>`;
  h+=S.servers.map(s=>`
    <div class="nav-server ${S.activeSrv?.id===s.id&&S.view==='server'?'active':''}" onclick="selectServer('${s.id}')">
      ${s.emoji} ${s.name}${s.channels.some(c=>c.notif)?` <span class="srv-notif">â—</span>`:''}
    </div>`).join('');
  el.innerHTML=h;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SERVER / CHANNEL / DM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showHome(){
  S.view='home'; S.activeSrv=null; S.activeCh=null; S.dmChannel=null;
  q('#chatIcon').textContent='âœ¦'; q('#chatName').textContent='Accueil'; q('#chatDesc').textContent='';
  renderNav(); renderChannels(); renderMembers();
  q('#messages').innerHTML=`<div class="empty-chat"><div class="big">ğŸ’¬</div><h3>Likoo</h3><p>Rejoignez un serveur ou dÃ©marrez une conversation.</p></div>`;
}
function showDM(){
  S.view='dm'; S.activeSrv=null; S.activeCh=null;
  renderNav(); renderChannels();
  if(!S.dmChannel){
    q('#chatIcon').textContent='ğŸ’¬'; q('#chatName').textContent='Messages PrivÃ©s'; q('#chatDesc').textContent='';
    q('#messages').innerHTML=`<div class="empty-chat"><div class="big">ğŸ’¬</div><h3>Choisissez une conversation</h3><p>SÃ©lectionnez un contact dans la liste â†’</p></div>`;
  }
}
function selectServer(id){
  S.view='server'; S.activeSrv=S.servers.find(s=>s.id===id); S.dmChannel=null;
  renderNav(); renderChannels(); renderMembers();
  const first=S.activeSrv.channels.find(c=>c.type!=='voice');
  if(first) selectChannel(first.id); else renderChat();
}
function selectChannel(id){
  const ch=S.activeSrv?.channels.find(c=>c.id===id); if(!ch)return;
  if(ch.type==='voice'){joinVoice(id);return;}
  S.activeCh=id; ch.notif=0;
  q('#chatIcon').textContent=ch.type==='announce'?'ğŸ“¢':'#';
  q('#chatName').textContent=ch.name;
  q('#chatDesc').textContent=ch.desc||'';
  q('#msgInput').placeholder=`Message #${ch.name}â€¦`;
  if(!S.messages[id])S.messages[id]=[];
  renderChannels(); renderChat();
}
function selectDM(id){
  S.dmChannel=id; S.view='dm';
  const u=DEMO_DMS.find(d=>d.id===id);
  q('#chatIcon').textContent=u.av; q('#chatName').textContent=u.name;
  q('#chatDesc').textContent=u.status==='online'?'ğŸŸ¢ En ligne':'âš« Hors ligne';
  q('#msgInput').placeholder=`Message Ã  ${u.name}â€¦`;
  if(!S.messages[id])S.messages[id]=[];
  renderChannels(); renderChat();
  if(S.messages[id].length===0){
    setTimeout(()=>{
      pushMsg(id,{author:u,content:['Salut ! ğŸ‘‹','Hey !','Yo !'][rnd(0,2)]});
    },900);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER CHANNELS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderChannels(){
  const el=q('#channelsList'); if(!el)return;
  if(S.view==='dm'||!S.activeSrv){
    q('#chModIcon').textContent='ğŸ’¬'; q('#chModTitle').textContent='Messages PrivÃ©s';
    el.innerHTML=`<div class="ch-section-lbl">Conversations</div>
      ${DEMO_DMS.map(u=>`<div class="ch-item ${S.dmChannel===u.id?'active':''}" onclick="selectDM('${u.id}')">${u.av} ${u.name}</div>`).join('')}
      <div style="padding:8px;margin-top:6px"><button class="btn btn-primary" style="width:100%;font-size:12px;padding:7px" onclick="alert('Ajoutez un ami par son tag !')">+ Ajouter un ami</button></div>`;
    return;
  }
  const srv=S.activeSrv;
  q('#chModIcon').textContent='#'; q('#chModTitle').textContent=srv.name;
  const texts=srv.channels.filter(c=>c.type!=='voice');
  const vcs=srv.channels.filter(c=>c.type==='voice');
  el.innerHTML=`
    <div class="ch-section-lbl">Salons<span class="ch-add-btn" onclick="openModal('modalCreateChannel')">+</span></div>
    ${texts.map(c=>`<div class="ch-item ${S.activeCh===c.id?'active':''}" onclick="selectChannel('${c.id}')">
      <span class="ch-hash">${c.type==='announce'?'ğŸ“¢':'#'}</span>${c.name}${c.notif?`<span class="ch-notif">${c.notif}</span>`:''}
    </div>`).join('')}
    <div class="ch-section-lbl" style="margin-top:6px">Vocaux<span class="ch-add-btn" onclick="openModal('modalCreateChannel')">+</span></div>
    ${vcs.map(c=>`<div class="ch-item ${S.activeCh===c.id?'active':''}" onclick="selectChannel('${c.id}')">ğŸ”Š ${c.name}</div>`).join('')}
    ${S.inVoice?`<div class="voice-strip">ğŸ”Š ${S.inVoice} <span class="voice-leave" onclick="leaveVoice()">âœ• Quitter</span></div>`:''}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER MEMBERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMembers(){
  const el=q('#membersList'); if(!el)return;
  const srv=S.activeSrv; if(!srv){el.innerHTML='';return;}
  const grps=[
    {l:'Admin',m:srv.members.filter(m=>m.role==='Admin'&&m.status!=='offline')},
    {l:'ModÃ©rateur',m:srv.members.filter(m=>m.role==='ModÃ©rateur'&&m.status!=='offline')},
    {l:'En ligne',m:srv.members.filter(m=>m.role==='Membre'&&m.status==='online')},
    {l:'Absent',m:srv.members.filter(m=>m.status==='away'&&m.role==='Membre')},
    {l:'Hors ligne',m:srv.members.filter(m=>m.status==='offline')},
  ].filter(g=>g.m.length);
  const self=[{name:S.me.name,av:S.me.av,color:S.me.color,status:S.me.status,role:'Membre'}];
  let h=mkMemGroup('Toi',self);
  grps.forEach(g=>h+=mkMemGroup(`${g.l} â€” ${g.m.length}`,g.m));
  el.innerHTML=h;
}
function mkMemGroup(label,list){
  return`<div class="mem-lbl">${label}</div>${list.map(m=>`
    <div class="mem-item">
      <div class="mem-av" style="background:${m.color}18"><span>${m.av||m.avatar}</span><div class="mem-dot ${m.status}" style="border-color:var(--bg2)"></div></div>
      <div><div class="mem-name">${m.name}</div><div class="mem-role">${m.role||''}</div></div>
    </div>`).join('')}`;
}
function toggleMembers(){
  S.membersVisible=!S.membersVisible;
  const z=q('#zoneRight');
  z.style.display=S.membersVisible?'flex':'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderChat(){
  const key=activeKey();
  const msgs=key?(S.messages[key]||[]):[];
  const el=q('#messages'); if(!el)return;
  if(!key||msgs.length===0){
    const ch=S.activeSrv?.channels.find(c=>c.id===S.activeCh);
    el.innerHTML=`<div class="empty-chat">
      <div class="big">${S.view==='dm'?'ğŸ’¬':'#'}</div>
      <h3>${S.view==='dm'?'DÃ©but de la conversation':'#'+(ch?.name||'salon')}</h3>
      <p style="font-size:13px">${key?'Soyez le premier Ã  Ã©crire ici !':'SÃ©lectionnez un salon.'}</p>
    </div>`;
    return;
  }
  el.innerHTML=msgs.map((m,i)=>{
    if(m.system)return`<div class="sys-line">${m.content}</div>`;
    const prev=msgs[i-1];
    const compact=S.compact&&prev&&!prev.system&&prev.author?.name===m.author?.name;
    const auth=m.author||S.me;
    const isMe=auth.name===S.me.name;
    const reacts=(m.reactions||[]).map(r=>`<span class="react-chip ${r.mine?'mine':''}" onclick="toggleReact('${key}',${m.id},'${r.e}')">${r.e} ${r.c}</span>`).join('');
    const body=m.file?(m.file.type.startsWith('image/')?`<img src="${m.file.data}" class="img-msg">`:`<div class="file-chip">ğŸ“„ ${m.file.name}</div>`):`<div class="msg-content">${esc(m.content)}</div>`;
    const acts=`<div class="msg-acts">
      <button class="msg-act-btn" onclick="quickReact('${key}',${m.id})">ğŸ˜Š</button>
      ${isMe?`<button class="msg-act-btn" onclick="editMsg('${key}',${m.id})">âœï¸</button>`:''}
      ${isMe?`<button class="msg-act-btn" style="color:var(--red)" onclick="delMsg('${key}',${m.id})">ğŸ—‘</button>`:''}
    </div>`;
    if(compact)return`<div class="msg-group">
      <div style="width:36px;text-align:center;font-size:10px;color:var(--text4);padding-top:3px;flex-shrink:0">${m.time}</div>
      <div class="msg-body">${body}<div>${reacts}</div></div>${acts}
    </div>`;
    return`<div class="msg-group">
      <div class="msg-av" style="background:${auth.color}18">${auth.av||auth.avatar}</div>
      <div class="msg-body">
        <div class="msg-meta"><span class="msg-author" style="color:${auth.color}">${auth.name}</span><span class="msg-time">${m.time}</span></div>
        ${body}<div>${reacts}</div>
      </div>${acts}
    </div>`;
  }).join('');
  setTimeout(()=>{const e=q('#messages');if(e)e.scrollTop=e.scrollHeight;},30);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MESSAGING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function activeKey(){return S.view==='dm'?S.dmChannel:S.activeCh;}
function pushMsg(key,data){
  if(!S.messages[key])S.messages[key]=[];
  S.messages[key].push({id:Date.now(),time:now(),reactions:[],...data});
  if(activeKey()===key)renderChat();
}
function sendMsg(){
  const inp=q('#msgInput');const text=inp?.value.trim();const key=activeKey();
  if(!text||!key)return;
  pushMsg(key,{author:{name:S.me.name,av:S.me.av,color:S.me.color},content:text});
  inp.value='';inp.style.height='';
  if(Math.random()>.45&&S.view==='server')setTimeout(()=>simReply(key),900+rnd(0,1800));
  if(S.view==='dm')setTimeout(()=>simDM(key),700+rnd(0,1200));
}
function simReply(key){
  const online=DEMO_MEMBERS.filter(m=>m.status==='online');
  const m=online[rnd(0,online.length-1)];
  const lines=['Trop bien !','Haha oui ğŸ˜‚','Je suis d\'accord','On vocal ?','++','â¤ï¸','Bien jouÃ© !'];
  pushMsg(key,{author:m,content:lines[rnd(0,lines.length-1)]});
}
function simDM(key){
  if(S.dmChannel!==key)return;
  const u=DEMO_DMS.find(d=>d.id===key);if(!u)return;
  const lines=['ğŸ˜Š','OK !','Ouais !','ğŸ‘','Vraiment ?','Haha'];
  pushMsg(key,{author:u,content:lines[rnd(0,lines.length-1)]});
}
let typT;
function simTyping(){
  if(Math.random()>.65&&S.view==='server'){
    const m=DEMO_MEMBERS.filter(m=>m.status==='online')[rnd(0,1)];
    const el=q('#typingHint');if(el)el.textContent=`${m.name} est en train d'Ã©crireâ€¦`;
    clearTimeout(typT);typT=setTimeout(()=>{const e=q('#typingHint');if(e)e.textContent='';},2000);
  }
}
function toggleReact(key,id,e){
  const msg=S.messages[key]?.find(m=>m.id===id);if(!msg)return;
  const ex=msg.reactions.find(r=>r.e===e);
  if(ex){ex.mine?ex.c--:ex.c++;ex.mine=!ex.mine;if(ex.c<=0)msg.reactions=msg.reactions.filter(r=>r.e!==e);}
  else msg.reactions.push({e,c:1,mine:true});
  renderChat();
}
function quickReact(key,id){toggleReact(key,id,['â¤ï¸','ğŸ‘','ğŸ˜‚','ğŸ”¥','ğŸ‰','ğŸ‘€'][rnd(0,5)]);}
function editMsg(key,id){const msg=S.messages[key]?.find(m=>m.id===id);if(!msg)return;const t=prompt('Modifier :',msg.content);if(t?.trim()){msg.content=t.trim()+' *(modifiÃ©)*';renderChat();}}
function delMsg(key,id){S.messages[key]=S.messages[key].filter(m=>m.id!==id);renderChat();}
function handleKey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();}}
function autoResize(t){t.style.height='';t.style.height=Math.min(t.scrollHeight,100)+'px';}
function handleFile(inp){
  const file=inp.files[0];if(!file)return;const key=activeKey();if(!key)return;
  const r=new FileReader();
  r.onload=e=>{pushMsg(key,{author:{name:S.me.name,av:S.me.av,color:S.me.color},content:'',file:{name:file.name,type:file.type,size:fmtB(file.size),data:e.target.result}});};
  r.readAsDataURL(file);inp.value='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VOICE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function joinVoice(id){
  const ch=S.activeSrv?.channels.find(c=>c.id===id);
  S.inVoice={id,name:ch?.name||'Vocal',muted:false,deafened:false,streaming:false,members:[S.me,...DEMO_MEMBERS.slice(0,2)]};
  S.activeCh=id;
  renderChannels();
  renderVoiceControls();
  updateTitlebar('Vocal: '+S.inVoice.name);
}
function leaveVoice(){
  S.inVoice=null;S.activeCh=null;
  renderChannels();
  q('#voicePanel')?.remove();
  updateTitlebar('Accueil');
}
function toggleMute(){
  if(!S.inVoice)return;
  S.inVoice.muted=!S.inVoice.muted;
  renderVoiceControls();
}
function toggleDeafen(){
  if(!S.inVoice)return;
  S.inVoice.deafened=!S.inVoice.deafened;
  if(S.inVoice.deafened)S.inVoice.muted=true;
  renderVoiceControls();
}
function toggleStream(){
  if(!S.inVoice)return;
  S.inVoice.streaming=!S.inVoice.streaming;
  renderVoiceControls();
}
function renderVoiceControls(){
  let panel=q('#voicePanel');
  if(!S.inVoice){
    if(panel)panel.remove();
    return;
  }
  if(!panel){
    panel=document.createElement('div');
    panel.id='voicePanel';
    panel.className='voice-panel';
    q('#messages')?.parentElement.insertBefore(panel,q('#messages'));
  }
  const members=S.inVoice.members.map(m=>`
    <div class="voice-member">
      <div class="vmem-av" style="background:${m.color}20"><span>${m.av}</span></div>
      <div class="vmem-info"><div class="vmem-name">${m.name}</div><div class="vmem-status">En vocal</div></div>
      ${m.name===S.me.name?'<div style="font-size:11px;color:var(--text4);">C\'est toi</div>':''}
    </div>`).join('');
  panel.innerHTML=`
    <div class="voice-header">
      <div>ğŸ”Š ${S.inVoice.name} â€” ${S.inVoice.members.length} personne(s)</div>
      <button class="voice-close" onclick="leaveVoice()">âœ•</button>
    </div>
    <div class="voice-members">${members}</div>
    <div class="voice-controls">
      <button class="voice-btn ${S.inVoice.muted?'active':''}" onclick="toggleMute()" title="Micro">
        <span class="voice-icon">ğŸ™</span><span class="voice-label">Micro</span>
      </button>
      <button class="voice-btn ${S.inVoice.deafened?'active':''}" onclick="toggleDeafen()" title="Casque">
        <span class="voice-icon">ğŸ§</span><span class="voice-label">Casque</span>
      </button>
      <button class="voice-btn ${S.inVoice.streaming?'active':''}" onclick="toggleStream()" title="Stream">
        <span class="voice-icon">ğŸ“¹</span><span class="voice-label">Stream</span>
      </button>
      <button class="voice-btn" style="background:var(--red);color:white" onclick="leaveVoice()" title="Quitter">
        <span class="voice-icon">ğŸ“</span><span class="voice-label">Quitter</span>
      </button>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SERVERS / CHANNELS MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function createServer(){
  const name=q('#srvName')?.value.trim();if(!name)return;
  const emoji=q('#srvEmoji')?.value.trim()||'ğŸŒ';
  const id='srv_'+Date.now();
  S.servers.push({id,name,emoji,
    channels:[{id:id+'_g',name:'gÃ©nÃ©ral',type:'text',desc:'Principal'},{id:id+'_v',name:'Vocal',type:'voice'}],
    members:[DEMO_MEMBERS[rnd(0,3)]]});
  S.messages[id+'_g']=[{id:Date.now(),system:true,content:`${S.me.name} a crÃ©Ã© "${name}" ğŸ‰`,time:now(),reactions:[]}];
  q('#srvName').value='';q('#srvEmoji').value='';
  closeModal('modalCreateServer');selectServer(id);
}
let newChType='text';
function selChType(el){document.querySelectorAll('.chip').forEach(c=>c.classList.remove('sel'));el.classList.add('sel');newChType=el.dataset.type;}
function createChannel(){
  if(!S.activeSrv)return;
  const name=q('#newChName')?.value.trim().toLowerCase().replace(/\s+/g,'-')||'nouveau';
  S.activeSrv.channels.push({id:S.activeSrv.id+'_'+name+'_'+Date.now(),name,type:newChType,desc:''});
  q('#newChName').value='';closeModal('modalCreateChannel');renderChannels();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EMOJI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildEmoji(){
  const el=q('#emojiPicker');if(!el)return;
  el.innerHTML=`<div class="emoji-grid">${EMOJIS.map(e=>`<button class="emoji-cell" onclick="insEmoji('${e}')">${e}</button>`).join('')}</div>`;
}
function toggleEmoji(){q('#emojiPicker')?.classList.toggle('open');}
function insEmoji(e){const i=q('#msgInput');if(i){i.value+=e;i.focus();}q('#emojiPicker')?.classList.remove('open');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id){q(`#${id}`)?.classList.add('open');}
function closeModal(id){q(`#${id}`)?.classList.remove('open');}
function openSettings(){
  if(S.me)q('#setName').value=S.me.name;
  openModal('modalSettings');
}
function saveSettings(){
  if(S.me){
    const n=q('#setName')?.value.trim()||S.me.name;
    S.me.name=n;save();
    const el=q('#dockName');if(el)el.textContent=n;
    q('#navName').textContent=n;
  }
  localStorage.setItem('likoo_theme',S.theme);
  localStorage.setItem('likoo_layout',S.layout);
  closeModal('modalSettings');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS: STATUS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setStatus(el){
  document.querySelectorAll('.st-chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  const s=el.dataset.status;if(!S.me)return;S.me.status=s;save();
  const colors={online:'var(--green)',away:'#f59e0b',dnd:'var(--red)',offline:'#7f8c8d'};
  ['navStatusDot','dockDot'].forEach(id=>{const d=q('#'+id);if(d){d.className='st-dot '+s;d.style.background=colors[s];}});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS: THEMES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const THEME_MAP={
  amber:{bg:'#faf6ef',bg2:'#f2ebe0',bg3:'#e8dece',bg4:'#dfd3be',panel:'#ece8f6',panel2:'#e3ddf2',accent:'#e8850a',accent2:'#f5a033',accent3:'#fbbf60',nav:'#5c3d1e',nav2:'#7a5230',text:'#2c1a08',text2:'#6b4a28',text3:'#a07850',text4:'#c4a882',border:'rgba(92,61,30,0.12)',border2:'rgba(92,61,30,0.22)',shadow:'rgba(92,61,30,0.10)',red:'#c0392b',green:'#27ae60',hl:'rgba(232,133,10,0.15)',hlb:'rgba(232,133,10,0.5)'},
  violet:{bg:'#f0edf8',bg2:'#e8e3f5',bg3:'#ddd6f0',bg4:'#cfc7e8',panel:'#ece8f6',panel2:'#e3ddf2',accent:'#8b5cf6',accent2:'#a78bfa',accent3:'#c4b5fd',nav:'#3b1f6e',nav2:'#4c2d87',text:'#1e1033',text2:'#4a3a72',text3:'#8b7ab8',text4:'#b8acd6',border:'rgba(139,92,246,0.14)',border2:'rgba(139,92,246,0.28)',shadow:'rgba(109,40,217,0.10)',red:'#ef4444',green:'#22c55e',hl:'rgba(139,92,246,0.12)',hlb:'rgba(139,92,246,0.5)'},
  night:{bg:'#0f1117',bg2:'#161922',bg3:'#1e2130',bg4:'#252a3a',panel:'#1a1d2e',panel2:'#20233a',accent:'#38bdf8',accent2:'#7dd3fc',accent3:'#bae6fd',nav:'#090c14',nav2:'#0e1220',text:'#e2e8f0',text2:'#94a3b8',text3:'#64748b',text4:'#475569',border:'rgba(56,189,248,0.12)',border2:'rgba(56,189,248,0.25)',shadow:'rgba(0,0,0,0.3)',red:'#f87171',green:'#4ade80',hl:'rgba(56,189,248,0.10)',hlb:'rgba(56,189,248,0.5)'},
  sakura:{bg:'#fff0f5',bg2:'#ffe4ee',bg3:'#ffd6e5',bg4:'#ffc2d7',panel:'#fce8f1',panel2:'#f9dce8',accent:'#e879a0',accent2:'#f472b6',accent3:'#fbcfe8',nav:'#831843',nav2:'#9d174d',text:'#3b0018',text2:'#831843',text3:'#be185d',text4:'#db2777',border:'rgba(232,121,160,0.15)',border2:'rgba(232,121,160,0.30)',shadow:'rgba(131,24,67,0.10)',red:'#dc2626',green:'#16a34a',hl:'rgba(232,121,160,0.12)',hlb:'rgba(232,121,160,0.55)'},
  forest:{bg:'#0d1f13',bg2:'#122018',bg3:'#182b1e',bg4:'#1f3327',panel:'#162418',panel2:'#1c2e1e',accent:'#4ade80',accent2:'#86efac',accent3:'#bbf7d0',nav:'#052010',nav2:'#063018',text:'#d1fae5',text2:'#6ee7b7',text3:'#34d399',text4:'#10b981',border:'rgba(74,222,128,0.12)',border2:'rgba(74,222,128,0.22)',shadow:'rgba(0,0,0,0.30)',red:'#f87171',green:'#4ade80',hl:'rgba(74,222,128,0.10)',hlb:'rgba(74,222,128,0.5)'},
  golden:{bg:'#fffbeb',bg2:'#fef3c7',bg3:'#fde68a',bg4:'#fcd34d',panel:'#fff8e1',panel2:'#fef0c0',accent:'#d97706',accent2:'#f59e0b',accent3:'#fcd34d',nav:'#78350f',nav2:'#92400e',text:'#3d1a00',text2:'#78350f',text3:'#b45309',text4:'#d97706',border:'rgba(217,119,6,0.15)',border2:'rgba(217,119,6,0.30)',shadow:'rgba(120,53,15,0.10)',red:'#dc2626',green:'#16a34a',hl:'rgba(217,119,6,0.12)',hlb:'rgba(217,119,6,0.55)'},
};

function applyTheme(el){
  const t=el.dataset.theme;
  document.querySelectorAll('.theme-card').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  applyThemeVal(t);
}
function applyThemeVal(t){
  S.theme=t;
  const th=THEME_MAP[t];if(!th)return;
  const r=document.documentElement.style;
  r.setProperty('--bg',th.bg);r.setProperty('--bg2',th.bg2);r.setProperty('--bg3',th.bg3);r.setProperty('--bg4',th.bg4);
  r.setProperty('--panel',th.panel);r.setProperty('--panel2',th.panel2);
  r.setProperty('--accent',th.accent);r.setProperty('--accent2',th.accent2);r.setProperty('--accent3',th.accent3);
  r.setProperty('--nav',th.nav);r.setProperty('--nav2',th.nav2);
  r.setProperty('--text',th.text);r.setProperty('--text2',th.text2);r.setProperty('--text3',th.text3);r.setProperty('--text4',th.text4);
  r.setProperty('--border',th.border);r.setProperty('--border2',th.border2);
  r.setProperty('--shadow',th.shadow);r.setProperty('--red',th.red);r.setProperty('--green',th.green);
  r.setProperty('--zone-hl',th.hl);r.setProperty('--zone-border',th.hlb);
  // Update theme card active state
  document.querySelectorAll('.theme-card').forEach(c=>{c.classList.toggle('active',c.dataset.theme===t);});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS: LAYOUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
/*
  Layouts dÃ©finissent:
  - grid-template-columns du workspace
  - quel module est dans quelle zone
  - visibilitÃ© des zones
*/
const LAYOUTS = {
  'default':    {cols:'240px 1fr 220px', left:'mod-channels', center:'mod-chat', right:'mod-members', showRight:true},
  'focus':      {cols:'220px 1fr',       left:'mod-channels', center:'mod-chat', right:null,           showRight:false},
  'compact':    {cols:'200px 1fr 180px', left:'mod-channels', center:'mod-chat', right:'mod-members',  showRight:true},
  'wide-chat':  {cols:'1fr 220px',       left:null,           center:'mod-chat', right:'mod-channels', showRight:true},
  'reversed':   {cols:'220px 1fr 240px', left:'mod-members',  center:'mod-chat', right:'mod-channels', showRight:true},
  'minimal':    {cols:'1fr',             left:null,           center:'mod-chat', right:null,           showRight:false},
};

function applyLayout(el){
  const l=el.dataset.layout;
  document.querySelectorAll('.layout-card').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  applyLayoutVal(l);
}
function applyLayoutVal(l){
  S.layout=l;
  const cfg=LAYOUTS[l];if(!cfg)return;
  const ws=q('#workspace');
  ws.style.transition='grid-template-columns .4s cubic-bezier(.4,0,.2,1)';
  ws.style.gridTemplateColumns=cfg.cols;

  const zl=q('#zoneLeft'), zc=q('#zoneCenter'), zr=q('#zoneRight');

  // Show/hide zones
  zl.style.display=(cfg.left||cfg.cols.split(' ').length>1&&cfg.left!==null)?'flex':'none';
  zr.style.display=cfg.showRight?'flex':'none';

  // Move modules to correct zones
  function moveToZone(modId, zoneEl){
    if(!modId||!zoneEl)return;
    const mod=q('#'+modId);
    if(mod&&mod.parentElement!==zoneEl)zoneEl.appendChild(mod);
  }
  if(cfg.left)moveToZone(cfg.left,zl); else zl.style.display='none';
  moveToZone(cfg.center,zc);
  if(cfg.right&&cfg.showRight)moveToZone(cfg.right,zr);

  S.membersVisible=cfg.showRight;

  // Update layout card active
  document.querySelectorAll('.layout-card').forEach(c=>c.classList.toggle('active',c.dataset.layout===l));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS: FONT / SIZE / TOGGLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyFont(el){
  document.querySelectorAll('.font-chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  document.documentElement.style.setProperty('--body-font',el.dataset.font);
  document.body.style.fontFamily=el.dataset.font+',sans-serif';
}
function applyFontSize(v){
  q('#fontSizeVal').textContent=v;
  document.documentElement.style.fontSize=v+'px';
}
function toggleAnim(cb){
  S.anim=cb.checked;
  const style=q('#animStyle')||createStyleEl('animStyle');
  style.textContent=S.anim?'':'.msg-group{animation:none!important}';
}
function toggleCompact(cb){S.compact=cb.checked;renderChat();}
function createStyleEl(id){const s=document.createElement('style');s.id=id;document.head.appendChild(s);return s;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAG & DROP MODULES (snap-to-zone)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onModDragStart(e,id){
  S.dragMod=id;
  e.dataTransfer.effectAllowed='move';
  e.dataTransfer.setData('text/plain',id);
  setTimeout(()=>{const m=q('#'+id);if(m)m.classList.add('is-dragging');},0);
  // Highlight all droppable zones
  ['zoneLeft','zoneRight','zoneCenter'].forEach(zid=>{
    const z=q('#'+zid);
    if(z&&z.style.display!=='none')z.setAttribute('data-droppable','1');
  });
}
function onModDragEnd(){
  if(S.dragMod)q('#'+S.dragMod)?.classList.remove('is-dragging');
  S.dragMod=null;
  document.querySelectorAll('.zone').forEach(z=>{z.classList.remove('drop-target');z.removeAttribute('data-droppable');});
}
function onZoneDragOver(e,zone){
  if(!S.dragMod)return;
  e.preventDefault();e.dataTransfer.dropEffect='move';
  const zoneIds={left:'zoneLeft',right:'zoneRight',center:'zoneCenter'};
  const z=q('#'+zoneIds[zone]);
  if(z)z.classList.add('drop-target');
}
function onZoneDragLeave(e,zone){
  const zoneIds={left:'zoneLeft',right:'zoneRight',center:'zoneCenter'};
  const z=q('#'+zoneIds[zone]);
  // Only remove if truly leaving the zone element
  if(z&&!z.contains(e.relatedTarget))z.classList.remove('drop-target');
}
function onZoneDrop(e,zone){
  e.preventDefault();
  const modId=S.dragMod||e.dataTransfer.getData('text/plain');
  const zoneIds={left:'zoneLeft',right:'zoneRight',center:'zoneCenter'};
  const targetZone=q('#'+zoneIds[zone]);
  if(!modId||!targetZone)return;
  const mod=q('#'+modId);
  if(!mod)return;

  // Don't drop on own zone
  if(mod.parentElement===targetZone){
    document.querySelectorAll('.zone').forEach(z=>z.classList.remove('drop-target'));
    return;
  }

  // Swap: if target zone already has a module, swap them
  const existingMod=targetZone.querySelector('.module');
  const sourceZone=mod.parentElement;
  if(existingMod&&sourceZone){
    sourceZone.appendChild(existingMod);
  }
  targetZone.appendChild(mod);

  document.querySelectorAll('.zone').forEach(z=>z.classList.remove('drop-target'));
  S.dragMod=null;

  // Update layout name to 'custom'
  document.querySelectorAll('.layout-card').forEach(c=>c.classList.remove('active'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MISC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleBtn(b){b.style.opacity=b.style.opacity==='0.4'?'1':'0.4';}
function q(s){return document.querySelector(s);}
function now(){return new Date().toLocaleTimeString('fr',{hour:'2-digit',minute:'2-digit'});}
function rnd(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function fmtB(b){return b<1024?b+' B':b<1048576?(b/1024).toFixed(1)+' KB':(b/1048576).toFixed(1)+' MB';}

// Mobile tab switching (simple show/hide)
function mobSwitch(tab){
  document.querySelectorAll('.mob-tab').forEach(b=>b.classList.remove('active'));
  q('#mobTab'+tab.charAt(0).toUpperCase()+tab.slice(1).charAt(0).toUpperCase()+tab.slice(2))?.classList.add('active');
  const zl=q('#zoneLeft'),zc=q('#zoneCenter'),zr=q('#zoneRight');
  if(!zl||!zc||!zr)return;
  zl.style.display='none';zc.style.display='none';zr.style.display='none';
  if(tab==='servers'){/* handled by showDM/selectServer via channels panel */zl.style.display='flex';}
  else if(tab==='channels'){zl.style.display='flex';}
  else if(tab==='chat'){zc.style.display='flex';}
  else if(tab==='members'){zr.style.display='flex';}
}

// Close overlays/emoji on outside click
document.addEventListener('click',e=>{
  if(!e.target.closest('#emojiPicker')&&!e.target.closest('.inp-btn'))q('#emojiPicker')?.classList.remove('open');
  if(e.target.classList.contains('overlay'))e.target.classList.remove('open');
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TITLEBAR & WINDOW CONTROLS (Electron)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateTitlebar(location){
  const loc=q('#titlebarLocation');
  if(loc)loc.textContent=location;
}

// Window controls
q('#minBtn')?.addEventListener('click',()=>window.electron?.ipc.send('window:minimize'));
q('#maxBtn')?.addEventListener('click',()=>window.electron?.ipc.send('window:maximize'));
q('#closeBtn')?.addEventListener('click',()=>window.electron?.ipc.send('window:close'));

// Initialize titlebar location
updateTitlebar('Accueil');
</script>
</body>
</html>
