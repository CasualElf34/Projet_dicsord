<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Likoo</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script src="resize.js"></script>
</head>
<body data-theme="amber">

<script>
  // DÃ©tecter si on est dans Electron ou sur le web
  if (window.electron || window.electronAPI) {
    document.documentElement.classList.add('is-electron');
    document.body.classList.add('is-electron');
  } else {
    // Sur le web, on ne montre pas la titlebar
    document.documentElement.classList.remove('is-electron');
  }
</script>

<!-- CUSTOM TITLEBAR (Electron) -->
<div id="titlebar" class="titlebar">
  <div class="titlebar-left">
    <span class="titlebar-logo">Likoo</span>
    <span class="titlebar-sep">|</span>
    <span class="titlebar-location" id="titlebarLocation">Accueil</span>
  </div>
  <div class="titlebar-right">
    <button id="minBtn" class="win-btn" title="Minimiser">â€”</button>
    <button id="maxBtn" class="win-btn" title="Maximiser">â–¡</button>
    <button id="closeBtn" class="win-btn" title="Fermer">âœ•</button>
  </div>
</div>

<!-- TOP NAV -->
<div class="topnav">
  <div class="logo" onclick="showHome()">Likoo</div>
  <div class="nav-servers" id="navServers"></div>
  <div class="nav-sep"></div>
  <div class="nav-add" onclick="openModal('modalCreateServer')">+ Serveur</div>
  <div class="nav-sep"></div>
  <div class="nav-profile">
    <div class="nav-av" id="navAv" onclick="openSettings()">
      <div class="st-dot online" id="navStatusDot"></div>
    </div>
    <div class="nav-username" id="navName">â€”</div>
    <button class="nav-btn" onclick="toggleBtn(this)" title="Micro">ğŸ™</button>
    <button class="nav-btn" onclick="toggleBtn(this)" title="Casque">ğŸ§</button>
    <button class="nav-btn settings-btn" onclick="openSettings()" title="ParamÃ¨tres">âš™</button>
  </div>
</div>

<!-- WORKSPACE â€” 3 zones -->
<div class="workspace" id="workspace">

  <!-- ZONE LEFT -->
  <div class="zone zone-left" id="zoneLeft" ondragover="onZoneDragOver(event,'left')" ondragleave="onZoneDragLeave(event,'left')" ondrop="onZoneDrop(event,'left')">
    <!-- channels by default -->
    <div class="module" id="mod-channels" draggable="true" ondragstart="onModDragStart(event,'mod-channels')" ondragend="onModDragEnd()">
      <div class="module-header">
        <span class="drag-handle">â‹®â‹®</span>
        <span class="module-icon" id="chModIcon">#</span>
        <span class="module-title" id="chModTitle">Salons</span>
        <button class="header-btn" id="serverSettingsBtn" style="display:none;margin-left:auto" onclick="openServerSettings()" title="ParamÃ¨tres">âš™ï¸</button>
      </div>
      <div class="search-bar"><span>ğŸ”</span><input type="text" placeholder="Rechercherâ€¦"></div>
      <div class="channels-scroll" id="channelsList"></div>
    </div>
  </div>

  <!-- ZONE CENTER -->
  <div class="zone zone-center" id="zoneCenter">
    <!-- chat by default -->
    <div class="module" id="mod-chat" draggable="true" ondragstart="onModDragStart(event,'mod-chat')" ondragend="onModDragEnd()">
      <!-- Chat topbar -->
      <div class="chat-topbar">
        <span class="chat-icon" id="chatIcon">#</span>
        <span class="chat-name" id="chatName">Likoo</span>
        <span class="chat-desc" id="chatDesc"></span>
        <div class="topbar-btns">
          <button class="topbar-btn">ğŸ“Œ</button>
          <button class="topbar-btn" onclick="toggleMembers()">ğŸ‘¥</button>
        </div>
      </div>
      <!-- Messages -->
      <div class="messages" id="messages">
        <div class="empty-chat">
          <div class="big">ğŸ’¬</div>
          <h3>Bienvenue sur Likoo</h3>
          <p style="font-size:13px">Rejoignez un serveur ou dÃ©marrez une conversation âœ¨</p>
        </div>
      </div>
      <!-- Input -->
      <div class="input-area">
        <div class="emoji-picker" id="emojiPicker"></div>
        <div class="typing-hint" id="typingHint"></div>
        <div class="input-box">
          <button class="inp-btn" onclick="document.getElementById('fileIn').click()">ğŸ“</button>
          <input type="file" id="fileIn" style="display:none" onchange="handleFile(this)">
          <textarea id="msgInput" rows="1" placeholder="Messageâ€¦" onkeydown="handleKey(event)" oninput="autoResize(this);simTyping()"></textarea>
          <button class="inp-btn" onclick="toggleEmoji()">ğŸ˜Š</button>
          <button class="send-btn" onclick="sendMsg()">â¤</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ZONE RIGHT -->
  <div class="zone zone-right" id="zoneRight" ondragover="onZoneDragOver(event,'right')" ondragleave="onZoneDragLeave(event,'right')" ondrop="onZoneDrop(event,'right')">
    <!-- members by default -->
    <div class="module" id="mod-members" draggable="true" ondragstart="onModDragStart(event,'mod-members')" ondragend="onModDragEnd()">
      <div class="module-header">
        <span class="drag-handle">â‹®â‹®</span>
        <span class="module-icon">ğŸ‘¥</span>
        <span class="module-title">Membres</span>
      </div>
      <div class="members-scroll" id="membersList"></div>
    </div>
  </div>

</div>

<!-- MOBILE BOTTOM NAV -->
<div id="mob-nav">
  <button class="mob-tab active" id="mobTabSrv" onclick="mobSwitch('servers')">ğŸ <span>Serveurs</span></button>
  <button class="mob-tab" id="mobTabCh" onclick="mobSwitch('channels')">â˜°<span>Salons</span></button>
  <button class="mob-tab" id="mobTabChat" onclick="mobSwitch('chat')">ğŸ’¬<span>Chat</span></button>
  <button class="mob-tab" id="mobTabMem" onclick="mobSwitch('members')">ğŸ‘¥<span>Membres</span></button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Setup -->
<div class="overlay" id="modalSetup">
  <div class="modal">
    <h2>Bienvenue sur Likoo ğŸ‘‹</h2>
    <p class="sub">CrÃ©ez votre profil pour rejoindre la discussion.</p>
    <input type="text" id="setupName" placeholder="Ton nom d'affichage" maxlength="32">
    <input type="text" id="setupTag" placeholder="Tag numÃ©rique (ex: 1234)" maxlength="4">
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="setupAccount()">Entrer dans Likoo ğŸš€</button>
    </div>
  </div>
</div>

<!-- Create Server -->
<!-- MODAL AJOUTER AMI -->
<div class="overlay" id="modalAddFriend">
  <div class="modal" style="max-width:420px">
    <h2>â• Ajouter un ami</h2>
    <p class="sub">Entre le pseudo et le tag de ton ami (ex: Alex#1234)</p>
    <div style="display:flex;gap:8px">
      <input type="text" id="friendUsername" placeholder="Pseudo" style="flex:1">
      <input type="text" id="friendTag" placeholder="#Tag" style="width:80px" maxlength="4">
    </div>
    <div id="friendRequestError" style="color:#f87171;font-size:12px;margin-top:6px;display:none"></div>
    <div id="friendRequestSuccess" style="color:#4ade80;font-size:12px;margin-top:6px;display:none"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalAddFriend')">Annuler</button>
      <button class="btn btn-primary" onclick="sendFriendRequest()">Envoyer la demande</button>
    </div>
  </div>
</div>

<!-- MODAL DEMANDES D'AMI -->
<div class="overlay" id="modalFriendRequests">
  <div class="modal" style="max-width:440px">
    <h2>ğŸ‘¥ Demandes d'ami</h2>
    <div id="friendRequestsList" style="display:flex;flex-direction:column;gap:10px;margin:16px 0;max-height:300px;overflow-y:auto"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalFriendRequests')">Fermer</button>
    </div>
  </div>
</div>

<div class="overlay" id="modalCreateServer">
  <div class="modal">
    <h2>CrÃ©er un serveur âœ¨</h2>
    <p class="sub">Donnez un nom et une ambiance Ã  votre communautÃ©.</p>
    <input type="text" id="srvName" placeholder="Nom du serveur" maxlength="32">
    <input type="text" id="srvEmoji" placeholder="Emoji (ex: ğŸ® ğŸµ ğŸ¨)" maxlength="2">
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalCreateServer')">Annuler</button>
      <button class="btn btn-primary" onclick="createServer()">CrÃ©er</button>
    </div>
  </div>
</div>

<!-- Server Settings Modal - Discord Style -->
<div class="overlay" id="modalServerSettings">
  <div class="modal" style="max-width:1100px;width:96%;height:75vh;overflow:hidden;display:flex;flex-direction:column;padding:0;background:var(--bg)">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:24px 28px;border-bottom:1px solid var(--border);flex-shrink:0">
      <h2 style="margin:0;font-size:26px;font-weight:900">ParamÃ¨tres du serveur</h2>
      <button class="btn btn-ghost" style="width:40px;height:40px;padding:0;font-size:22px" onclick="closeModal('modalServerSettings')">âœ•</button>
    </div>
    
    <div style="display:flex;flex:1;overflow:hidden">
      <!-- Menu latÃ©ral FIXE -->
      <div style="width:280px;background:var(--bg2);border-right:1px solid var(--border);overflow-y:auto;flex-shrink:0">
        <div style="padding:18px 16px 12px;font-size:11px;font-weight:800;color:var(--text4);text-transform:uppercase;letter-spacing:1.2px">Utilisateur</div>
        <div onclick="switchServerTab('profile')" style="padding:14px 18px;cursor:pointer;color:var(--text2);font-size:15px;transition:all .15s;border-left:3px solid transparent" id="tabBtnProfile" class="srv-settings-tab-btn active">
          ğŸ‘¤ Profil du serveur
        </div>
        <div onclick="switchServerTab('members')" style="padding:14px 18px;cursor:pointer;color:var(--text3);font-size:15px;transition:all .15s;border-left:3px solid transparent" id="tabBtnMembers" class="srv-settings-tab-btn">
          ğŸ‘¥ Membres
        </div>
        
        <div style="padding:18px 16px 12px;font-size:11px;font-weight:800;color:var(--text4);text-transform:uppercase;letter-spacing:1.2px">Gestion</div>
        <div onclick="switchServerTab('roles')" style="padding:14px 18px;cursor:pointer;color:var(--text3);font-size:15px;transition:all .15s;border-left:3px solid transparent" id="tabBtnRoles" class="srv-settings-tab-btn">
          ğŸ­ RÃ´les
        </div>
        <div onclick="switchServerTab('channels')" style="padding:14px 18px;cursor:pointer;color:var(--text3);font-size:15px;transition:all .15s;border-left:3px solid transparent" id="tabBtnChannels" class="srv-settings-tab-btn">
          ğŸ’¬ Salons
        </div>
        
        <div style="padding:18px 16px 12px;font-size:11px;font-weight:800;color:var(--text4);text-transform:uppercase;letter-spacing:1.2px">Danger</div>
        <div onclick="switchServerTab('delete')" style="padding:14px 18px;cursor:pointer;color:#f87171;font-size:15px;transition:all .15s;border-left:3px solid transparent" id="tabBtnDelete" class="srv-settings-tab-btn">
          ğŸ—‘ï¸ Supprimer
        </div>
      </div>
      
      <!-- Contenu SCROLLABLE avec hauteur fixa -->
      <div style="flex:1;overflow-y:auto;overflow-x:hidden;padding:28px 36px;display:flex;flex-direction:column;min-height:0">
        <!-- TAB: PROFILE -->
        <div id="tabProfile" class="settings-tab-content" style="display:block">
          <h3 style="font-size:22px;font-weight:900;margin:0 0 32px 0">Profil du serveur</h3>
          
          <div style="margin-bottom:36px">
            <label style="font-size:12px;font-weight:800;color:var(--text4);text-transform:uppercase;letter-spacing:1px">IcÃ´ne du Serveur</label>
            <div style="display:flex;align-items:center;gap:24px;margin-top:16px">
              <div id="serverIconPreview" style="width:110px;height:110px;border-radius:20px;background:var(--bg2);display:flex;align-items:center;justify-content:center;font-size:52px;cursor:pointer;border:2px dashed var(--border2);flex-shrink:0" onclick="document.getElementById('serverIconInput').click()"></div>
              <div>
                <p style="font-size:15px;color:var(--text2);margin:0 0 8px 0;font-weight:700">Changer l'icÃ´ne</p>
                <p style="font-size:13px;color:var(--text4);margin:0;line-height:1.6">Cliquez pour en sÃ©lectionner une. JPG, PNG (max 5 MB)</p>
                <input type="file" id="serverIconInput" accept="image/*" style="display:none" onchange="handleServerIconUpload(this)">
              </div>
            </div>
          </div>
          
          <div style="margin-bottom:24px">
            <label style="font-size:12px;font-weight:800;color:var(--text4);text-transform:uppercase;letter-spacing:1px">Nom du Serveur</label>
            <input type="text" id="serverSettingsName" maxlength="100" style="width:100%;margin-top:10px;padding:14px 16px;background:var(--bg);border:1.5px solid var(--border2);border-radius:10px;font-size:15px;color:var(--text);box-sizing:border-box;font-family:inherit;font-weight:500">
          </div>
          
          <div style="margin-bottom:36px">
            <label style="font-size:12px;font-weight:800;color:var(--text4);text-transform:uppercase;letter-spacing:1px">Description</label>
            <textarea id="serverSettingsDesc" maxlength="500" style="width:100%;margin-top:10px;padding:14px 16px;background:var(--bg);border:1.5px solid var(--border2);border-radius:10px;font-size:15px;color:var(--text);resize:none;height:160px;box-sizing:border-box;font-family:inherit;font-weight:500"></textarea>
          </div>
          
          <div id="serverSettingsError" style="color:#f87171;font-size:14px;margin-bottom:16px;display:none;padding:12px 14px;background:rgba(248,113,113,.1);border-radius:8px;border-left:3px solid #f87171"></div>
          <div id="serverSettingsSuccess" style="color:#4ade80;font-size:14px;margin-bottom:16px;display:none;padding:12px 14px;background:rgba(74,222,128,.1);border-radius:8px;border-left:3px solid #4ade80"></div>
          
          <div style="display:flex;gap:14px;justify-content:flex-end;margin-top:auto;padding-top:24px;border-top:1px solid var(--border)">
            <button class="btn btn-ghost" onclick="closeModal('modalServerSettings')">Annuler</button>
            <button class="btn btn-primary" onclick="saveServerSettings()">Enregistrer les modifications</button>
          </div>
        </div>
        
        <!-- TAB: ROLES -->
        <div id="tabRoles" class="settings-tab-content" style="display:none">
          <h3 style="font-size:22px;font-weight:900;margin:0 0 14px 0">Gestion des rÃ´les</h3>
          <p style="color:var(--text3);font-size:15px;margin:0 0 28px 0;line-height:1.6">Utilisez des rÃ´les pour regrouper les membres et leur assigner des permissions.</p>
          
          <button class="btn btn-primary" onclick="addNewRole()" style="margin-bottom:28px;font-size:15px">+ CrÃ©er un rÃ´le</button>
          
          <div id="rolesList" style="display:flex;flex-direction:column;gap:16px;margin-bottom:auto"></div>
          <div id="rolesError" style="color:#f87171;font-size:14px;display:none;padding:12px 14px;background:rgba(248,113,113,.1);border-radius:8px;border-left:3px solid #f87171"></div>
        </div>
        
        <!-- TAB: MEMBERS -->
        <div id="tabMembers" class="settings-tab-content" style="display:none">
          <h3 style="font-size:22px;font-weight:900;margin:0 0 28px 0">Membres du serveur</h3>
          <div id="settingsMembers" style="display:flex;flex-direction:column;gap:12px"></div>
        </div>
        
        <!-- TAB: CHANNELS -->
        <div id="tabChannels" class="settings-tab-content" style="display:none">
          <h3 style="font-size:22px;font-weight:900;margin:0 0 24px 0">Salons</h3>
          <button class="btn btn-primary" onclick="openModal('modalCreateChannel')" style="margin-bottom:28px;font-size:15px">+ Nouveau salon</button>
          <div id="settingsChannels" style="display:flex;flex-direction:column;gap:0;padding:8px 0"></div>
        </div>
        
        <!-- TAB: DELETE -->
        <div id="tabDelete" class="settings-tab-content" style="display:none">
          <h3 style="font-size:22px;font-weight:900;margin:0 0 28px 0;color:var(--red)">Zone de danger</h3>
          <div style="padding:24px;background:rgba(192,57,43,.08);border:1.5px solid rgba(192,57,43,.25);border-radius:14px;max-width:600px">
            <h4 style="margin:0 0 12px 0;color:var(--red);font-size:17px;font-weight:800">Supprimer le serveur</h4>
            <p style="margin:0 0 20px 0;color:var(--text3);font-size:14px;line-height:1.7">Une fois le serveur supprimÃ©, il n'y a aucun moyen de le rÃ©cupÃ©rer. Cette action est irrÃ©versible.</p>
            <button class="btn btn-danger" onclick="deleteServerConfirm()" style="background:#f87171;color:#7f1d1d;font-size:15px">Supprimer le serveur</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Create Channel -->
<div class="overlay" id="modalCreateChannel">
  <div class="modal">
    <h2>Nouveau salon</h2>
    <p class="sub">Ajoutez un salon Ã  votre serveur.</p>
    <input type="text" id="newChName" placeholder="nom-du-salon" maxlength="32">
    <div class="chip-row">
      <div class="chip sel" data-type="text" onclick="selChType(this)">ğŸ’¬ Texte</div>
      <div class="chip" data-type="voice" onclick="selChType(this)">ğŸ”Š Vocal</div>
      <div class="chip" data-type="announce" onclick="selChType(this)">ğŸ“¢ Annonces</div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalCreateChannel')">Annuler</button>
      <button class="btn btn-primary" onclick="createChannel()">CrÃ©er</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SETTINGS MODAL â€” ParamÃ¨tres complets
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="modalSettings">
  <div class="modal" style="max-width:560px">
    <h2>ParamÃ¨tres âš™</h2>
    <p class="sub">Personnalisez Likoo Ã  votre goÃ»t.</p>

    <!-- Profil -->
    <div class="settings-section">
      <h3>ğŸ™‹ Mon profil</h3>
      <div class="avatar-upload-row">
        <!-- clicking the circle opens file picker -->
        <div id="avatarPreview" class="avatar-preview" onclick="document.getElementById('avatarInput').click()"></div>
        <input type="file" id="avatarInput" accept="image/*" style="display:none" onchange="uploadAvatar(this)">
      </div>
      <input type="text" id="setName" placeholder="Nom d'affichage">
      <div style="margin-bottom:10px">
        <div style="font-size:11px;font-weight:700;color:var(--text4);margin-bottom:7px">STATUT</div>
        <div class="status-row" id="statusRow">
          <div class="st-chip active" data-status="online" onclick="setStatus(this)">ğŸŸ¢ En ligne</div>
          <div class="st-chip" data-status="away" onclick="setStatus(this)">ğŸŸ¡ Absent</div>
          <div class="st-chip" data-status="dnd" onclick="setStatus(this)">ğŸ”´ Ne pas dÃ©ranger</div>
          <div class="st-chip" data-status="offline" onclick="setStatus(this)">âš« Invisible</div>
        </div>
      </div>
    </div>

    <!-- ThÃ¨mes -->
    <div class="settings-section">
      <h3>ğŸ¨ ThÃ¨me de couleurs</h3>
      <div class="theme-grid" id="themeGrid">

        <div class="theme-card active" data-theme="amber" onclick="applyTheme(this)">
          <div class="theme-preview">
            <div class="theme-preview-nav" style="background:#5c3d1e"></div>
            <div class="theme-preview-content" style="background:#faf6ef">
              <div class="theme-preview-bar" style="background:#e8850a"></div>
              <div class="theme-preview-msg" style="background:#6b4a28"></div>
              <div class="theme-preview-msg" style="background:#6b4a28;width:55%"></div>
            </div>
          </div>
          <div class="theme-name">Ambre Chaud</div>
        </div>

        <div class="theme-card" data-theme="violet" onclick="applyTheme(this)">
          <div class="theme-preview">
            <div class="theme-preview-nav" style="background:#3b1f6e"></div>
            <div class="theme-preview-content" style="background:#f0edf8">
              <div class="theme-preview-bar" style="background:#8b5cf6"></div>
              <div class="theme-preview-msg" style="background:#4a3a72"></div>
              <div class="theme-preview-msg" style="background:#4a3a72;width:50%"></div>
            </div>
          </div>
          <div class="theme-name">Violet Pastel</div>
        </div>

        <div class="theme-card" data-theme="night" onclick="applyTheme(this)">
          <div class="theme-preview">
            <div class="theme-preview-nav" style="background:#090c14"></div>
            <div class="theme-preview-content" style="background:#0f1117">
              <div class="theme-preview-bar" style="background:#38bdf8"></div>
              <div class="theme-preview-msg" style="background:#64748b"></div>
              <div class="theme-preview-msg" style="background:#64748b;width:60%"></div>
            </div>
          </div>
          <div class="theme-name">Minuit</div>
        </div>

        <div class="theme-card" data-theme="sakura" onclick="applyTheme(this)">
          <div class="theme-preview">
            <div class="theme-preview-nav" style="background:#831843"></div>
            <div class="theme-preview-content" style="background:#fff0f5">
              <div class="theme-preview-bar" style="background:#e879a0"></div>
              <div class="theme-preview-msg" style="background:#be185d"></div>
              <div class="theme-preview-msg" style="background:#be185d;width:45%"></div>
            </div>
          </div>
          <div class="theme-name">Sakura</div>
        </div>

        <div class="theme-card" data-theme="forest" onclick="applyTheme(this)">
          <div class="theme-preview">
            <div class="theme-preview-nav" style="background:#052010"></div>
            <div class="theme-preview-content" style="background:#0d1f13">
              <div class="theme-preview-bar" style="background:#4ade80"></div>
              <div class="theme-preview-msg" style="background:#34d399"></div>
              <div class="theme-preview-msg" style="background:#34d399;width:65%"></div>
            </div>
          </div>
          <div class="theme-name">ForÃªt</div>
        </div>

        <div class="theme-card" data-theme="golden" onclick="applyTheme(this)">
          <div class="theme-preview">
            <div class="theme-preview-nav" style="background:#78350f"></div>
            <div class="theme-preview-content" style="background:#fffbeb">
              <div class="theme-preview-bar" style="background:#d97706"></div>
              <div class="theme-preview-msg" style="background:#78350f"></div>
              <div class="theme-preview-msg" style="background:#78350f;width:55%"></div>
            </div>
          </div>
          <div class="theme-name">DorÃ©</div>
        </div>

      </div>
    </div>

    <!-- Disposition des modules -->
    <div class="settings-section">
      <h3>ğŸ“ Disposition des modules</h3>
      <p style="font-size:12px;color:var(--text4);margin-bottom:10px">Cliquez pour appliquer â€” ou glissez-dÃ©posez les blocs manuellement dans les zones.</p>
      <div class="layout-grid" id="layoutGrid">

        <div class="layout-card active" data-layout="default" onclick="applyLayout(this)">
          <div class="layout-preview">
            <div class="lp-block" style="width:28%"></div>
            <div class="lp-main"></div>
            <div class="lp-block" style="width:24%"></div>
          </div>
          <div class="layout-label">Classique</div>
        </div>

        <div class="layout-card" data-layout="focus" onclick="applyLayout(this)">
          <div class="layout-preview">
            <div class="lp-block" style="width:24%"></div>
            <div class="lp-main"></div>
          </div>
          <div class="layout-label">Focus (sans membres)</div>
        </div>

        <div class="layout-card" data-layout="compact" onclick="applyLayout(this)">
          <div class="layout-preview">
            <div class="lp-block" style="width:20%"></div>
            <div class="lp-main"></div>
            <div class="lp-block" style="width:18%"></div>
          </div>
          <div class="layout-label">Compact</div>
        </div>

        <div class="layout-card" data-layout="wide-chat" onclick="applyLayout(this)">
          <div class="layout-preview">
            <div class="lp-main"></div>
            <div class="lp-block" style="width:28%"></div>
          </div>
          <div class="layout-label">Chat Large</div>
        </div>

        <div class="layout-card" data-layout="reversed" onclick="applyLayout(this)">
          <div class="layout-preview">
            <div class="lp-block" style="width:24%"></div>
            <div class="lp-main"></div>
            <div class="lp-block" style="width:28%"></div>
          </div>
          <div class="layout-label">InversÃ©</div>
        </div>

        <div class="layout-card" data-layout="minimal" onclick="applyLayout(this)">
          <div class="layout-preview">
            <div class="lp-main"></div>
          </div>
          <div class="layout-label">Minimaliste</div>
        </div>

      </div>
    </div>

    <!-- Police -->
    <div class="settings-section">
      <h3>ğŸ”¤ Police d'Ã©criture</h3>
      <div class="font-row">
        <div class="font-chip active" data-font="Plus Jakarta Sans" onclick="applyFont(this)" style="font-family:'Plus Jakarta Sans',sans-serif">Jakarta</div>
        <div class="font-chip" data-font="Georgia" onclick="applyFont(this)" style="font-family:Georgia,serif">Georgia</div>
        <div class="font-chip" data-font="'Courier New'" onclick="applyFont(this)" style="font-family:'Courier New',monospace">Courier</div>
        <div class="font-chip" data-font="Verdana" onclick="applyFont(this)" style="font-family:Verdana,sans-serif">Verdana</div>
      </div>
    </div>

    <!-- Taille du texte -->
    <div class="settings-section">
      <h3>ğŸ”¡ Taille du texte</h3>
      <div class="slider-row">
        <span style="font-size:11px;color:var(--text4)">A</span>
        <input type="range" min="11" max="18" value="13" id="fontSizeSlider" oninput="applyFontSize(this.value)">
        <span style="font-size:16px;color:var(--text4)">A</span>
        <span class="slider-val" id="fontSizeVal">13</span>
      </div>
    </div>

    <!-- Toggles -->
    <div class="settings-section">
      <h3>âš™ PrÃ©fÃ©rences</h3>
      <div class="toggle-row">
        <span class="toggle-label">Animations des messages</span>
        <label class="toggle"><input type="checkbox" checked onchange="toggleAnim(this)"><div class="toggle-track"></div></label>
      </div>
      <div class="toggle-row">
        <span class="toggle-label">Compact (messages groupÃ©s)</span>
        <label class="toggle"><input type="checkbox" onchange="toggleCompact(this)"><div class="toggle-track"></div></label>
      </div>
      <div class="toggle-row">
        <span class="toggle-label">Notifications sonores</span>
        <label class="toggle"><input type="checkbox" checked><div class="toggle-track"></div></label>
      </div>
    </div>

    <div class="modal-actions" style="justify-content:space-between">
      <button class="btn btn-ghost" onclick="logout()" style="color:#f87171;border-color:#f8717140">â» Se dÃ©connecter</button>
      <div style="display:flex;gap:8px">
        <button class="btn btn-ghost" onclick="closeModal('modalSettings')">Fermer</button>
        <button class="btn btn-primary" onclick="saveSettings()">Sauvegarder</button>
      </div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = {
  me: null,
  servers: [],
  activeSrv: null,
  activeCh: null,
  dmChannel: null,
  view: 'home',
  messages: {},
  inVoice: null,
  theme: 'amber',
  layout: 'default',
  dragMod: null,
  membersVisible: true,
  compact: false,
  anim: true,
  friends: [],
  pendingRequests: 0,
};

const COLORS  = ['#e8850a','#8b5cf6','#ec4899','#14b8a6','#3b82f6','#22c55e','#ef4444','#f59e0b'];
const AVATARS = ['ğŸ¦Š','ğŸ‘¾','ğŸ‰','ğŸŒŸ','ğŸ¦','ğŸº','ğŸ¦‹','ğŸ™','ğŸ­','ğŸ¦„','ğŸ»','ğŸ¸'];
const EMOJIS  = ['ğŸ˜€','ğŸ˜‚','â¤ï¸','ğŸ‘','ğŸ‰','ğŸ”¥','âœ¨','ğŸ˜','ğŸ¤”','ğŸ˜…','ğŸ‘€','ğŸ’¯','ğŸš€','ğŸ®','ğŸ’œ','ğŸ˜','ğŸ¤£','ğŸ‘‹','ğŸ’ª','ğŸ¦„','âš¡','ğŸŒŸ','ğŸ˜­','ğŸ¥º','ğŸ¤¯','ğŸ˜','ğŸ¤™','ğŸ’€','ğŸ•','ğŸµ'];

// helper for avatar rendering
function formatAvatar(av){
  if(!av) {
    console.warn('âš ï¸ Avatar vide:', av);
    return '<span style="font-size:15px">ğŸ‘¤</span>';
  }
  if(typeof av==='string' && (
      av.startsWith('http')||av.startsWith('/')||av.startsWith('data:')
    )){
    return `<img src="${av}" class="avatar-img" alt="avatar" onerror="this.outerHTML='<span style=\\'font-size:15px\\'>ğŸ‘¤</span>'">`;
  }
  if(typeof av === 'string') {
    return `<span style="font-size:15px">${av}</span>`;
  }
  console.error('âŒ Avatar invalide (type:', typeof av, '):', av);
  return '<span style="font-size:15px">ğŸ‘¤</span>';
}

let selectedAvatar = 'ğŸ‘¤';
let selectedAvatarFile = null;

// upload avatar from settings
function uploadAvatar(input){
  const file = input.files[0];
  if(!file) return;
  selectedAvatarFile = file;
  const reader = new FileReader();
  reader.onload = e=>{
    const dataUrl = e.target.result;
    document.getElementById('avatarPreview').innerHTML = `<img src="${dataUrl}">`;
    selectedAvatar = dataUrl;
    // update local state right away so it persists even before server responds
    if(S.me){
      S.me.av = dataUrl;
      save();
      updateNavAv();
      renderServers();
      renderMembers();
      // ensure member list self avatar also updates
      const mem = q('#membersList .mem-item:first-child img');
      if(mem) mem.src = S.me.av;
    }
  };
  reader.readAsDataURL(file);
  // send to server immediately if logged in
  const _avatarToken = localStorage.getItem('likoo_token');
  if(S.me && _avatarToken){
    const form = new FormData();
    form.append('avatar', file);
    fetch('http://localhost:5000/api/auth/avatar',{
      method:'POST',
      body: form,
      headers:{'Authorization':'Bearer '+_avatarToken}
    }).then(r=>r.json()).then(data=>{
      if(data.avatar){
        // backend returns path/url, update local state
        S.me.av = data.avatar;
        save();
        updateNavAv();
        renderServers();
        renderMembers();
        const mem = q('#membersList .mem-item:first-child img');
        if(mem) mem.src = S.me.av;
      } else if(data.error){
        alert('Erreur : '+data.error);
      }
    }).catch(err=>console.error('upload error',err));
  }
}

// handle file selection in static version
function handleRegAvatar(input){
  const file = input.files[0];
  if(!file) return;
  selectedAvatarFile = file;
  const reader = new FileReader();
  reader.onload = e=>{
    document.getElementById('avatarPreview').innerHTML = `<img src="${e.target.result}">`;
    selectedAvatar = e.target.result;
  };
  reader.readAsDataURL(file);
}

const DEMO_MEMBERS = [
  {name:'Zara', tag:'4521',av:'ğŸ¦Š',color:'#e74c3c',status:'online', role:'Admin'},
  {name:'Nino', tag:'7788',av:'ğŸ‘¾',color:'#3b82f6',status:'online', role:'Membre'},
  {name:'LÃ©a',  tag:'3310',av:'ğŸ¦‹',color:'#22c55e',status:'away',   role:'Membre'},
  {name:'Max',  tag:'9001',av:'ğŸ‰',color:'#f59e0b',status:'dnd',    role:'ModÃ©rateur'},
  {name:'Sofia',tag:'1111',av:'ğŸŒŸ',color:'#9b59b6',status:'offline',role:'Membre'},
  {name:'Kev',  tag:'2222',av:'ğŸ¦',color:'#14b8a6',status:'offline',role:'Membre'},
];
const DEMO_DMS = [
  {id:'dm_zara',...DEMO_MEMBERS[0]},
  {id:'dm_nino',...DEMO_MEMBERS[1]},
  {id:'dm_lea', ...DEMO_MEMBERS[2]},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.onload = function() {
  const savedTheme = localStorage.getItem('likoo_theme');
  const savedLayout = localStorage.getItem('likoo_layout');
  if (savedTheme) applyThemeVal(savedTheme);
  if (savedLayout) applyLayoutVal(savedLayout);
  buildEmoji();

  const token = localStorage.getItem('likoo_token');
  const userJson = localStorage.getItem('likoo_user');

  if (!token || !userJson) {
    window.location.href = '/auth.html';
    return;
  }

  try {
    const u = JSON.parse(userJson);
    S.me = {
      id: u.id,
      name: u.username || u.name,
      av: u.avatar || u.av || 'ğŸ¦Š',
      color: u.color || '#94a3b8',
      status: u.status || 'online',
      tag: u.tag || '0000'
    };
  } catch(e) {
    window.location.href = '/auth.html';
    return;
  }

  fetch('http://localhost:5000/api/auth/me', {
    headers: { 'Authorization': 'Bearer ' + token }
  }).then(r => {
    if (r.status === 401) {
      localStorage.removeItem('likoo_token');
      localStorage.removeItem('likoo_user');
      window.location.href = '/auth.html';
      return null;
    }
    return r.json();
  }).then(u => {
    if (!u) return;
    S.me.id = u.id;
    S.me.name = u.username;
    S.me.av = u.avatar;
    S.me.color = u.color || S.me.color;
    S.me.status = u.status || 'online';
    S.me.tag = u.tag;
    startApp();
  }).catch(() => {
    // RÃ©seau indisponible â€” dÃ©marrage hors-ligne avec cache
    startApp();
  });
};

function startApp() {
  updateNavAv();
  initSocket();
  loadServers();
  loadFriends();
}

function showToast(msg) {
  let t = document.getElementById('_toast');
  if (!t) {
    t = document.createElement('div');
    t.id = '_toast';
    t.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--bg3);color:var(--text1);padding:10px 18px;border-radius:10px;font-size:13px;z-index:9999;box-shadow:0 4px 20px #0006;transition:opacity .3s';
    document.body.appendChild(t);
  }
  t.textContent = msg;
  t.style.opacity = '1';
  clearTimeout(t._timer);
  t._timer = setTimeout(() => { t.style.opacity = '0'; }, 3500);
}

async function loadServers() {
  const token = localStorage.getItem('likoo_token');
  if (!token) {
    console.log('No token, using demo data');
    buildDemo();
    renderNav();
    if (S.servers.length > 0) selectServer(S.servers[0].id);
    renderMembers();
    return;
  }
  try {
    const r = await fetch('http://localhost:5000/api/servers', {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const servers = await r.json();
    if (!Array.isArray(servers)) throw new Error('Invalid response format');
    
    S.servers = servers.map(srv => ({
      id: srv.id,
      name: srv.name,
      emoji: srv.icon || 'ğŸŒ',
      icon_image: srv.icon_image || null,
      owner_id: srv.owner_id,
      description: srv.description || '',
      channels: (srv.channels || []).map(ch => ({
        id: ch.id,
        name: ch.name,
        type: ch.type || 'text',
        desc: ch.description || '',
        notif: 0
      })),
      members: (srv.members || []).map(m => ({
        user_id: m.user_id,
        name: m.username,
        avatar: m.avatar,
        role: 'Membre',
        status: m.status || 'online'
      })),
      roles: srv.roles || []
    }));
    renderNav();
    if (S.servers.length > 0) {
      selectServer(S.servers[0].id);
    } else {
      renderChannels();
    }
    renderMembers();
  } catch(e) {
    console.error('loadServers error:', e);
    console.log('Using demo data due to error');
    buildDemo();
    renderNav();
    if (S.servers.length > 0) selectServer(S.servers[0].id);
    renderMembers();
  }
}

function buildDemo() {
  const t = now();
  S.servers = [{
    id:'demo', name:'Mon Serveur', emoji:'ğŸ ',
    channels:[
      {id:'gen',   name:'gÃ©nÃ©ral',       type:'text',    desc:'Espace principal',notif:2},
      {id:'intro', name:'introductions', type:'text',    desc:'PrÃ©sentez-vous !'},
      {id:'ann',   name:'annonces',      type:'announce',desc:''},
      {id:'gaming',name:'gaming',        type:'text',    desc:'ğŸ® Jeux vidÃ©o'},
      {id:'music', name:'musique',       type:'text',    desc:'ğŸµ Playlists'},
      {id:'vc1',   name:'Vocal lounge',  type:'voice'},
      {id:'vc2',   name:'Gaming VC',     type:'voice'},
    ],
    members: DEMO_MEMBERS,
  }];
  S.messages['gen'] = [
    {id:1,author:DEMO_MEMBERS[0],content:'Bienvenue sur Likoo ! ğŸ‰ Enfin notre propre espace.',time:t,reactions:[{e:'ğŸ‰',c:3},{e:'â¤ï¸',c:2}]},
    {id:2,author:DEMO_MEMBERS[1],content:'Trop bien ! J\'adore pouvoir dÃ©placer les modules.',time:t,reactions:[]},
    {id:3,author:DEMO_MEMBERS[2],content:'Et les thÃ¨mes en temps rÃ©el c\'est ouf ğŸ‘€',time:t,reactions:[{e:'ğŸ‘€',c:1}]},
    {id:4,author:DEMO_MEMBERS[3],content:'J\'ai invitÃ© tout le monde ğŸ”¥',time:t,reactions:[{e:'ğŸ”¥',c:4}]},
  ];
  S.messages['intro'] = [
    {id:5,author:DEMO_MEMBERS[1],content:'Salut ! Je suis Nino ğŸ®',time:t,reactions:[]},
    {id:6,author:DEMO_MEMBERS[2],content:'Moi c\'est LÃ©a, dev front ğŸ’»',time:t,reactions:[{e:'ğŸ’™',c:1}]},
  ];
  ['gaming','music','ann','vc1','vc2'].forEach(k=>S.messages[k]=[]);
  S.messages['dm_zara']=[{id:7,author:DEMO_MEMBERS[0],content:'Yo ! Tu as vu Likoo ? ğŸ˜',time:t,reactions:[]}];
  S.messages['dm_nino']=[]; S.messages['dm_lea']=[];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACCOUNT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupAccount() {
  const n=q('#setupName').value.trim()||'Utilisateur';
  const t=q('#setupTag').value.replace(/\D/g,'').slice(0,4).padStart(4,'0')||rnd(1000,9999).toString();
  S.me={name:n,tag:t,av:AVATARS[rnd(0,11)],color:COLORS[rnd(0,7)],status:'online'};
  save(); closeModal('modalSetup'); startApp();
}
function save(){localStorage.setItem('likoo_user',JSON.stringify(S.me));}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEBSOCKET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let socket = null;

function initSocket() {
  if (socket) return;
  socket = io('http://localhost:5000');

  socket.on('connect', () => {
    console.log('âœ… Socket connectÃ©');
    if (S.activeCh) socket.emit('join_channel', { channel_id: S.activeCh });
    // Rejoindre la room personnelle pour les notifs (demandes d'ami, etc.)
    if (S.me?.id) {
      socket.emit('join_user_room', { user_id: S.me.id });
      console.log('âœ… Rejoint room: user_' + S.me.id);
    } else {
      console.warn('âš ï¸ S.me.id non dÃ©fini lors de la connexion socket');
    }
  });

  socket.on('friend_request', (fr) => {
    S.pendingRequests = (S.pendingRequests || 0) + 1;
    if (!S._pendingList) S._pendingList = [];
    S._pendingList.push(fr);
    renderNav();
    if (S.view === 'dm') renderChannels();
    // Petite notification visuelle
    const name = fr.sender?.username || 'Quelqu\'un';
    showToast(`ğŸ‘¥ ${name} t'a envoyÃ© une demande d'ami !`);
  });

  socket.on('friend_accepted', (fr) => {
    loadFriends();
    const name = fr.receiver?.username || 'Quelqu\'un';
    showToast(`âœ… ${name} a acceptÃ© ta demande d'ami !`);
  });

  socket.on('new_dm', (msg) => {
    console.log('ğŸ“¨ new_dm reÃ§u:', msg);
    if (!msg?.author) {
      console.error('âŒ new_dm: author manquant', msg);
      return;
    }
    const key = msg.sender_id === S.me.id ? msg.receiver_id : msg.sender_id;
    if (!S.messages[key]) S.messages[key] = [];
    // Ignorer nos propres messages (dÃ©jÃ  affichÃ©s en optimiste)
    if (msg.sender_id === S.me.id) return;
    if (S.messages[key].some(m => m.id === msg.id)) return;
    S.messages[key].push({
      id: msg.id,
      content: msg.content,
      time: new Date(msg.created_at).toLocaleTimeString('fr', {hour:'2-digit', minute:'2-digit'}),
      reactions: [],
      author: { name: msg.author.username, av: msg.author.avatar, color: msg.author.color || '#94a3b8' }
    });
    console.log('âœ… DM ajoutÃ© Ã  la conversation avec clÃ©:', key);
    if (S.dmChannel === key) renderChat();
    else {
      const sender = (S.friends||[]).find(f=>f.id===key);
      if (sender) showToast(`ğŸ’¬ ${sender.username}: ${msg.content.slice(0,50)}`);
    }
  });

  socket.on('new_message', (msg) => {
    const key = msg.channel_id;
    if (!S.messages[key]) S.messages[key] = [];
    // Ignorer nos propres messages (dÃ©jÃ  affichÃ©s en optimiste)
    if (msg.author.username === S.me.name) return;
    if (S.messages[key].some(m => m.id === msg.id)) return;
    S.messages[key].push({
      id: msg.id,
      content: msg.content,
      time: new Date(msg.created_at).toLocaleTimeString('fr', {hour:'2-digit', minute:'2-digit'}),
      reactions: [],
      author: {
        name: msg.author.username,
        av: msg.author.avatar,
        color: msg.author.color || '#94a3b8'
      }
    });
    if (S.activeCh === key) renderChat();
  });

  socket.on('user_typing', (data) => {
    const el = document.getElementById('typingHint');
    if (!el) return;
    el.textContent = `${data.username} est en train d'Ã©crireâ€¦`;
    clearTimeout(socket._typingTimer);
    socket._typingTimer = setTimeout(() => {
      const e = document.getElementById('typingHint');
      if (e) e.textContent = '';
    }, 3000);
  });

  socket.on('server_icon_updated', (data) => {
    const srv = S.servers.find(s => s.id === data.server_id);
    if (srv) {
      srv.icon_image = data.icon_image;
      renderNav();
      if (S.activeSrv && S.activeSrv.id === data.server_id) {
        S.activeSrv.icon_image = data.icon_image;
        updateServerIconPreview();
      }
    }
  });

  socket.on('user_avatar_updated', (data) => {
    // Mettre Ã  jour l'avatar de l'utilisateur dans la liste des membres
    if (S.activeSrv) {
      const member = S.activeSrv.members.find(m => m.user_id === data.user_id);
      if (member) {
        member.avatar = data.avatar;
        renderMembers();
      }
    }
  });

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // WEBRTC LISTENERS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  socket.on('voice_user_joined', (data) => {
    console.log(`ğŸ‘¤ ${data.user_id} a rejoint le canal vocal`);
    if (S.inVoice && data.channel_id === S.activeCh) {
      WebRTC.addPeer(data.user_id);
    }
  });

  socket.on('voice_user_left', (data) => {
    console.log(`ğŸ‘¤ ${data.user_id} a quittÃ© le canal vocal`);
    WebRTC.removePeer(data.user_id);
  });

  socket.on('webrtc_offer', async (data) => {
    console.log(`ğŸ“¤ Offre reÃ§ue de ${data.from}`);
    await WebRTC.handleOffer(data.from, data.offer);
  });

  socket.on('webrtc_answer', async (data) => {
    console.log(`ğŸ“¥ RÃ©ponse reÃ§ue de ${data.from}`);
    await WebRTC.handleAnswer(data.from, data.answer);
  });

  socket.on('webrtc_ice_candidate', async (data) => {
    await WebRTC.handleIceCandidate(data.from, data.candidate);
  });

  socket.on('voice_mute_changed', (data) => {
    // Recevoir le changement de mute d'un autre utilisateur
    if (S.inVoice && data.channel_id === S.activeCh) {
      const member = S.inVoice.members.find(m => m.user_id === data.user_id);
      if (member) {
        member.muted = data.muted;
        renderVoiceControls();
      }
    }
  });

  socket.on('voice_deafen_changed', (data) => {
    // Recevoir le changement de deafen d'un autre utilisateur
    if (S.inVoice && data.channel_id === S.activeCh) {
      const member = S.inVoice.members.find(m => m.user_id === data.user_id);
      if (member) {
        member.deafened = data.deafened;
        renderVoiceControls();
      }
    }
  });

  socket.on('voice_streaming_started', (data) => {
    console.log(`ğŸ¬ ${data.name} commence Ã  partager son Ã©cran`);
    if (S.inVoice && data.channel_id === S.activeCh) {
      const member = S.inVoice.members.find(m => m.user_id === data.user_id);
      if (member) {
        member.streaming = true;
        renderVoiceControls();
      }
    }
  });

  socket.on('voice_streaming_stopped', (data) => {
    console.log(`â›” ${data.name} arrÃªte le partage d'Ã©cran`);
    if (S.inVoice && data.channel_id === S.activeCh) {
      const member = S.inVoice.members.find(m => m.user_id === data.user_id);
      if (member) {
        member.streaming = false;
        renderVoiceControls();
        // ArrÃªter d'afficher le stream
        const remoteStream = q('#remoteStream');
        if (remoteStream) {
          remoteStream.srcObject = null;
        }
      }
    }
  });
}

function logout() {
  if (socket) socket.disconnect();
  localStorage.removeItem('likoo_token');
  localStorage.removeItem('likoo_user');
  window.location.href = '/auth.html';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AMIS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadFriends() {
  const token = localStorage.getItem('likoo_token');
  try {
    const [frRes, reqRes] = await Promise.all([
      fetch('http://localhost:5000/api/friends', { headers: { 'Authorization': 'Bearer ' + token } }),
      fetch('http://localhost:5000/api/friends/requests', { headers: { 'Authorization': 'Bearer ' + token } })
    ]);
    S.friends = await frRes.json();
    const pending = await reqRes.json();
    S.pendingRequests = pending.length;
    S._pendingList = pending;
    renderNav();
    if (S.view === 'dm') renderChannels();
  } catch(e) { console.error('loadFriends:', e); }
}

async function sendFriendRequest() {
  const username = q('#friendUsername')?.value.trim();
  const tag = q('#friendTag')?.value.trim().replace('#','');
  const errEl = q('#friendRequestError');
  const okEl = q('#friendRequestSuccess');
  errEl.style.display='none'; okEl.style.display='none';
  if (!username || !tag) { errEl.textContent='Remplis les deux champs.'; errEl.style.display='block'; return; }
  const token = localStorage.getItem('likoo_token');
  try {
    const r = await fetch('http://localhost:5000/api/friends/request', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
      body: JSON.stringify({ username, tag })
    });
    const data = await r.json();
    if (!r.ok) { errEl.textContent = data.error || 'Erreur'; errEl.style.display='block'; return; }
    okEl.textContent = `Demande envoyÃ©e Ã  ${username}#${tag} !`;
    okEl.style.display='block';
    q('#friendUsername').value=''; q('#friendTag').value='';
  } catch(e) { errEl.textContent='Erreur rÃ©seau'; errEl.style.display='block'; }
}

function openFriendRequests() {
  const list = S._pendingList || [];
  const el = q('#friendRequestsList');
  if (!el) return;
  if (list.length === 0) {
    el.innerHTML = '<div style="color:var(--text4);font-size:13px">Aucune demande en attente</div>';
  } else {
    el.innerHTML = list.map(fr => `
      <div style="display:flex;align-items:center;gap:10px;padding:8px;background:var(--bg3);border-radius:8px">
        <div style="font-size:22px">${fr.sender.avatar||'ğŸ‘¤'}</div>
        <div style="flex:1">
          <div style="font-weight:600">${fr.sender.username}<span style="color:var(--text4);font-size:11px">#${fr.sender.tag}</span></div>
          <div style="font-size:11px;color:var(--text4)">Demande d'ami</div>
        </div>
        <button class="btn btn-primary" style="padding:5px 10px;font-size:12px" onclick="acceptFriend('${fr.id}')">âœ“</button>
        <button class="btn btn-ghost" style="padding:5px 10px;font-size:12px;color:#f87171" onclick="rejectFriend('${fr.id}')">âœ—</button>
      </div>`).join('');
  }
  openModal('modalFriendRequests');
}

async function acceptFriend(requestId) {
  const token = localStorage.getItem('likoo_token');
  await fetch(`http://localhost:5000/api/friends/requests/${requestId}/accept`, {
    method: 'POST', headers: { 'Authorization': 'Bearer ' + token }
  });
  await loadFriends();
  openFriendRequests();
}

async function rejectFriend(requestId) {
  const token = localStorage.getItem('likoo_token');
  await fetch(`http://localhost:5000/api/friends/requests/${requestId}/reject`, {
    method: 'POST', headers: { 'Authorization': 'Bearer ' + token }
  });
  await loadFriends();
  openFriendRequests();
}

function updateNavAv(){
  const el=q('#navAv'); if(!el||!S.me)return;
  const avHtml = formatAvatar(S.me.av);
  el.innerHTML=`${avHtml}<div class="st-dot ${S.me.status}" id="navStatusDot"></div>`;
  const navNameEl = q('#navName');
  navNameEl.innerHTML = `<div>${S.me.name}</div><div style="font-size:11px;opacity:0.7">#${S.me.tag}</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderNav(){
  const el=q('#navServers'); if(!el)return;
  const badge = S.pendingRequests>0 ? `<span style="background:#f87171;color:#fff;border-radius:999px;font-size:10px;padding:1px 5px;margin-left:4px">${S.pendingRequests}</span>` : '';
  let h=`<div class="nav-server ${S.view==='dm'?'active':''}" onclick="showDM()">ğŸ’¬ Messages privÃ©s${badge}</div>`;
  h+=S.servers.map(s=>{
    const icon = s.icon_image ? `<img src="${s.icon_image}" style="width:18px;height:18px;border-radius:3px;object-fit:cover" alt="icon">` : (s.emoji || 'ğŸ ');
    return `<div class="nav-server ${S.activeSrv?.id===s.id&&S.view==='server'?'active':''}" onclick="selectServer('${s.id}')">
      ${icon} ${s.name}${s.channels.some(c=>c.notif)?` <span class="srv-notif">â—</span>`:''}
    </div>`;
  }).join('');
  el.innerHTML=h;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SERVER / CHANNEL / DM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showHome(){
  S.view='home'; S.activeSrv=null; S.activeCh=null; S.dmChannel=null;
  q('#chatIcon').textContent='âœ¦'; q('#chatName').textContent='Accueil'; q('#chatDesc').textContent='';
  renderNav(); renderChannels(); renderMembers();
  q('#messages').innerHTML=`<div class="empty-chat"><div class="big">ğŸ’¬</div><h3>Likoo</h3><p>Rejoignez un serveur ou dÃ©marrez une conversation.</p></div>`;
}
function showDM(){
  S.view='dm'; S.activeSrv=null; S.activeCh=null;
  renderNav(); renderChannels();
  if(!S.dmChannel){
    q('#chatIcon').textContent='ğŸ’¬'; q('#chatName').textContent='Messages PrivÃ©s'; q('#chatDesc').textContent='';
    q('#messages').innerHTML=`<div class="empty-chat"><div class="big">ğŸ’¬</div><h3>Choisissez une conversation</h3><p>SÃ©lectionnez un contact dans la liste â†’</p></div>`;
  }
}
function selectServer(id){
  S.view='server'; S.activeSrv=S.servers.find(s=>s.id===id); S.dmChannel=null;
  // Rejoindre la room du serveur pour les mises Ã  jour (icÃ´ne, etc.)
  if (socket) socket.emit('join_server', { server_id: id });
  renderNav(); renderChannels(); renderMembers(); updateSettingsButtonVisibility();
  const first=S.activeSrv.channels.find(c=>c.type!=='voice');
  if(first) selectChannel(first.id); else renderChat();
}
function selectChannel(id){
  const ch=S.activeSrv?.channels.find(c=>c.id===id); if(!ch)return;
  if(ch.type==='voice'){joinVoice(id);return;}
  // Quitter l'ancien canal Socket.IO
  if (S.activeCh && socket) socket.emit('leave_channel', { channel_id: S.activeCh });
  S.activeCh=id; ch.notif=0;
  q('#chatIcon').textContent=ch.type==='announce'?'ğŸ“¢':'#';
  q('#chatName').textContent=ch.name;
  q('#chatDesc').textContent=ch.desc||'';
  q('#msgInput').placeholder=`Message #${ch.name}â€¦`;
  S.messages[id]=[];
  renderChannels(); renderChat();
  // Rejoindre le nouveau canal Socket.IO
  if (socket) socket.emit('join_channel', { channel_id: id });
  // Charger l'historique depuis le backend
  const token = localStorage.getItem('likoo_token');
  if (token && id.includes('-')) { // Vrai ID UUID, pas un ID local de dÃ©mo
    fetch(`http://localhost:5000/api/channels/${id}/messages`, {
      headers: { 'Authorization': 'Bearer ' + token }
    }).then(r => r.json()).then(msgs => {
      // VÃ©rifier que msgs est bien un tableau
      if (!Array.isArray(msgs)) {
        console.warn('Invalid response format for messages:', msgs);
        return;
      }
      // RÃ©cupÃ©rer les messages locaux (optimistes) dÃ©jÃ  affichÃ©s
      const localOnly = (S.messages[id] || []).filter(m => !m.id || typeof m.id === 'number');
      const history = msgs.map(m => ({
        id: m.id,
        content: m.content,
        time: new Date(m.created_at).toLocaleTimeString('fr', {hour:'2-digit', minute:'2-digit'}),
        reactions: [],
        author: { name: m.author.username, av: m.author.avatar, color: m.author.color || '#94a3b8' }
      }));
      // Fusionner : historique + messages locaux non encore confirmÃ©s
      S.messages[id] = [...history, ...localOnly];
      if (S.activeCh === id) renderChat();
    }).catch(e => console.error('load messages error:', e));
  }
}
async function selectDM(id){
  S.dmChannel=id; S.view='dm';
  const u=(S.friends||[]).find(f=>f.id===id);
  if(!u) return;
  q('#chatIcon').innerHTML=formatAvatar(u.avatar||'ğŸ‘¤');
  q('#chatName').textContent=u.username;
  q('#chatDesc').textContent=u.status==='online'?'ğŸŸ¢ En ligne':'âš« Hors ligne';
  q('#msgInput').placeholder=`Message Ã  ${u.username}â€¦`;
  if(!S.messages[id])S.messages[id]=[];
  renderChannels(); renderChat();
  // Charger l'historique depuis le backend
  const token=localStorage.getItem('likoo_token');
  if(token && id.includes('-')) { // Vrai ID UUID
    try{
      const res=await fetch(`http://localhost:5000/api/dm/${id}`,{headers:{'Authorization':'Bearer '+token}});
      const history=await res.json();
      // VÃ©rifier que history est un tableau
      if(!Array.isArray(history)){
        console.warn('Invalid DM response format:', history);
        return;
      }
      const mapped=history.map(m=>({
        id:m.id,
        content:m.content,
        time:new Date(m.created_at).toLocaleTimeString('fr',{hour:'2-digit',minute:'2-digit'}),
        reactions:[],
        author:{name:m.author.username,av:m.author.avatar,color:m.author.color||'#94a3b8'}
      }));
      const localOnly=(S.messages[id]||[]).filter(m=>typeof m.id==='number');
      S.messages[id]=[...mapped,...localOnly];
      if(S.dmChannel===id)renderChat();
    }catch(e){console.error('load dm error:',e);}
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER CHANNELS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderChannels(){
  const el=q('#channelsList'); if(!el)return;
  if(S.view==='dm'||!S.activeSrv){
    q('#chModIcon').textContent='ğŸ’¬'; q('#chModTitle').textContent='Messages PrivÃ©s';
    const reqBadge = S.pendingRequests>0 ? `<span style="background:#f87171;color:#fff;border-radius:999px;font-size:10px;padding:1px 5px;margin-left:4px">${S.pendingRequests}</span>` : '';
    el.innerHTML=`
      <div style="padding:8px;display:flex;gap:6px">
        <button class="btn btn-primary" style="flex:1;font-size:12px;padding:7px" onclick="openModal('modalAddFriend')">+ Ajouter un ami</button>
        <button class="btn btn-ghost" style="font-size:12px;padding:7px;position:relative" onclick="openFriendRequests()" title="Demandes reÃ§ues">ğŸ‘¥${reqBadge}</button>
      </div>
      <div class="ch-section-lbl">Amis</div>
      ${(S.friends||[]).length===0?'<div style="padding:8px 12px;font-size:12px;color:var(--text4)">Aucun ami pour l\'instant</div>':''}
      ${(S.friends||[]).map(u=>`<div class="ch-item ${S.dmChannel===u.id?'active':''}" onclick="selectDM('${u.id}')">${formatAvatar(u.avatar||'ğŸ‘¤')} ${u.username}</div>`).join('')}`;
    return;
  }
  const srv=S.activeSrv;
  q('#chModIcon').textContent='#'; q('#chModTitle').textContent=srv.name;
  const texts=srv.channels.filter(c=>c.type!=='voice');
  const vcs=srv.channels.filter(c=>c.type==='voice');
  el.innerHTML=`
    <div class="ch-section-lbl">Salons<span class="ch-add-btn" onclick="openModal('modalCreateChannel')">+</span></div>
    ${texts.map(c=>`<div class="ch-item ${S.activeCh===c.id?'active':''}" onclick="selectChannel('${c.id}')">
      <span class="ch-hash">${c.type==='announce'?'ğŸ“¢':'#'}</span>${c.name}${c.notif?`<span class="ch-notif">${c.notif}</span>`:''}
    </div>`).join('')}
    <div class="ch-section-lbl" style="margin-top:6px">Vocaux<span class="ch-add-btn" onclick="openModal('modalCreateChannel')">+</span></div>
    ${vcs.map(c=>`<div class="ch-item ${S.activeCh===c.id?'active':''}" onclick="selectChannel('${c.id}')">ğŸ”Š ${c.name}</div>`).join('')}
    ${S.inVoice?`<div class="voice-strip">ğŸ”Š ${S.inVoice} <span class="voice-leave" onclick="leaveVoice()">âœ• Quitter</span></div>`:''}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER MEMBERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMembers(){
  const el=q('#membersList'); if(!el)return;
  const srv=S.activeSrv; if(!srv){el.innerHTML='';return;}
  const grps=[
    {l:'Admin',m:srv.members.filter(m=>m.role==='Admin'&&m.status!=='offline')},
    {l:'ModÃ©rateur',m:srv.members.filter(m=>m.role==='ModÃ©rateur'&&m.status!=='offline')},
    {l:'En ligne',m:srv.members.filter(m=>m.role==='Membre'&&m.status==='online')},
    {l:'Absent',m:srv.members.filter(m=>m.status==='away'&&m.role==='Membre')},
    {l:'Ne pas dÃ©ranger',m:srv.members.filter(m=>m.status==='dnd'&&m.role==='Membre')},
    {l:'Hors ligne',m:srv.members.filter(m=>m.status==='offline')},
  ].filter(g=>g.m.length);
  let h='';
  grps.forEach(g=>h+=mkMemGroup(`${g.l} â€” ${g.m.length}`,g.m));
  el.innerHTML=h;
}
function mkMemGroup(label,list){
  return`<div class="mem-lbl">${label}</div>${list.map(m=>`
    <div class="mem-item">
      <div class="mem-av" style="background:${m.color}18">${formatAvatar(m.av||m.avatar)}<div class="mem-dot ${m.status}" style="border-color:var(--bg2)"></div></div>
      <div><div class="mem-name">${m.name}</div><div class="mem-role">${m.role||''}</div></div>
    </div>`).join('')}`;
}
function toggleMembers(){
  S.membersVisible=!S.membersVisible;
  const z=q('#zoneRight');
  z.style.display=S.membersVisible?'flex':'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderChat(){
  const key=activeKey();
  const msgs=key?(S.messages[key]||[]):[];
  const el=q('#messages'); if(!el)return;
  if(!key||msgs.length===0){
    const ch=S.activeSrv?.channels.find(c=>c.id===S.activeCh);
    el.innerHTML=`<div class="empty-chat">
      <div class="big">${S.view==='dm'?'ğŸ’¬':'#'}</div>
      <h3>${S.view==='dm'?'DÃ©but de la conversation':'#'+(ch?.name||'salon')}</h3>
      <p style="font-size:13px">${key?'Soyez le premier Ã  Ã©crire ici !':'SÃ©lectionnez un salon.'}</p>
    </div>`;
    return;
  }
  el.innerHTML=msgs.map((m,i)=>{
    if(m.system)return`<div class="sys-line">${m.content}</div>`;
    const prev=msgs[i-1];
    const compact=S.compact&&prev&&!prev.system&&prev.author?.name===m.author?.name;
    const auth=m.author||S.me;
    const isMe=auth.name===S.me.name;
    const reacts=(m.reactions||[]).map(r=>`<span class="react-chip ${r.mine?'mine':''}" onclick="toggleReact('${key}',${m.id},'${r.e}')">${r.e} ${r.c}</span>`).join('');
    const body=m.file?(m.file.type.startsWith('image/')?`<img src="${m.file.data}" class="img-msg">`:`<div class="file-chip">ğŸ“„ ${m.file.name}</div>`):`<div class="msg-content">${esc(m.content)}</div>`;
    const acts=`<div class="msg-acts">
      <button class="msg-act-btn" onclick="quickReact('${key}',${m.id})">ğŸ˜Š</button>
      ${isMe?`<button class="msg-act-btn" onclick="editMsg('${key}',${m.id})">âœï¸</button>`:''}
      ${isMe?`<button class="msg-act-btn" style="color:var(--red)" onclick="delMsg('${key}',${m.id})">ğŸ—‘</button>`:''}
    </div>`;
    if(compact)return`<div class="msg-group">
      <div style="width:36px;text-align:center;font-size:10px;color:var(--text4);padding-top:3px;flex-shrink:0">${m.time}</div>
      <div class="msg-body">${body}<div>${reacts}</div></div>${acts}
    </div>`;
    return`<div class="msg-group">
      <div class="msg-av" style="background:${auth.color}18">${formatAvatar(auth.av||auth.avatar)}</div>
      <div class="msg-body">
        <div class="msg-meta"><span class="msg-author" style="color:${auth.color}">${auth.name}</span><span class="msg-time">${m.time}</span></div>
        ${body}<div>${reacts}</div>
      </div>${acts}
    </div>`;
  }).join('');
  setTimeout(()=>{const e=q('#messages');if(e)e.scrollTop=e.scrollHeight;},30);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MESSAGING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function activeKey(){return S.view==='dm'?S.dmChannel:S.activeCh;}
function pushMsg(key,data){
  if(!S.messages[key])S.messages[key]=[];
  S.messages[key].push({id:Date.now(),time:now(),reactions:[],...data});
  if(activeKey()===key)renderChat();
}
function sendMsg(){
  const inp=q('#msgInput');const text=inp?.value.trim();const key=activeKey();
  if(!text||!key)return;
  inp.value='';inp.style.height='';
  // Affichage immÃ©diat (optimiste) dans tous les cas
  pushMsg(key,{author:{name:S.me.name,av:S.me.av,color:S.me.color},content:text});
  // Envoi au backend si socket + id dispo (persistence + broadcast aux autres)
  if(S.view==='server' && socket && S.me.id){
    console.log('ğŸ“¤ Envoi message au serveur:', {channel_id:key,user_id:S.me.id});
    socket.emit('send_message',{channel_id:key,content:text,user_id:S.me.id});
  } else if(S.view==='dm' && socket && S.me.id){
    console.log('ğŸ“¤ Envoi DM:', {sender_id:S.me.id,receiver_id:S.dmChannel});
    socket.emit('send_dm',{sender_id:S.me.id,receiver_id:S.dmChannel,content:text});
  }
}
function simReply(key){
  const online=DEMO_MEMBERS.filter(m=>m.status==='online');
  const m=online[rnd(0,online.length-1)];
  const lines=['Trop bien !','Haha oui ğŸ˜‚','Je suis d\'accord','On vocal ?','++','â¤ï¸','Bien jouÃ© !'];
  pushMsg(key,{author:m,content:lines[rnd(0,lines.length-1)]});
}
function simDM(key){
  if(S.dmChannel!==key)return;
  const u=DEMO_DMS.find(d=>d.id===key);if(!u)return;
  const lines=['ğŸ˜Š','OK !','Ouais !','ğŸ‘','Vraiment ?','Haha'];
  pushMsg(key,{author:u,content:lines[rnd(0,lines.length-1)]});
}
let typT;
function simTyping(){
  if(S.view==='server' && S.activeCh && socket){
    socket.emit('typing',{channel_id:S.activeCh,username:S.me.name});
  }
}
function toggleReact(key,id,e){
  const msg=S.messages[key]?.find(m=>m.id===id);if(!msg)return;
  const ex=msg.reactions.find(r=>r.e===e);
  if(ex){ex.mine?ex.c--:ex.c++;ex.mine=!ex.mine;if(ex.c<=0)msg.reactions=msg.reactions.filter(r=>r.e!==e);}
  else msg.reactions.push({e,c:1,mine:true});
  renderChat();
}
function quickReact(key,id){toggleReact(key,id,['â¤ï¸','ğŸ‘','ğŸ˜‚','ğŸ”¥','ğŸ‰','ğŸ‘€'][rnd(0,5)]);}
function editMsg(key,id){const msg=S.messages[key]?.find(m=>m.id===id);if(!msg)return;const t=prompt('Modifier :',msg.content);if(t?.trim()){msg.content=t.trim()+' *(modifiÃ©)*';renderChat();}}
function delMsg(key,id){S.messages[key]=S.messages[key].filter(m=>m.id!==id);renderChat();}
function handleKey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();}}
function autoResize(t){t.style.height='';t.style.height=Math.min(t.scrollHeight,100)+'px';}
function handleFile(inp){
  const file=inp.files[0];if(!file)return;const key=activeKey();if(!key)return;
  const r=new FileReader();
  r.onload=e=>{pushMsg(key,{author:{name:S.me.name,av:S.me.av,color:S.me.color},content:'',file:{name:file.name,type:file.type,size:fmtB(file.size),data:e.target.result}});};
  r.readAsDataURL(file);inp.value='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEBRTC MANAGER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WebRTC = {
  peers: {},           // { userId: RTCPeerConnection }
  localStream: null,   // MediaStream du microphone
  audioElements: {},   // { userId: HTMLAudioElement }
  
  async init() {
    try {
      console.log('ğŸ¤ Demande permission microphone...');
      this.localStream = await navigator.mediaDevices.getUserMedia({ 
        audio: { 
          echoCancellation: true, 
          noiseSuppression: true,
          autoGainControl: true 
        } 
      });
      console.log('âœ… Microphone activÃ©');
      return true;
    } catch(e) {
      console.error('âŒ Erreur microphone:', e);
      alert('Permission microphone refusÃ©e - audio non disponible');
      return false;
    }
  },
  
  async addPeer(userId) {
    if (this.peers[userId]) return; // DÃ©jÃ  connectÃ©
    
    console.log(`â• CrÃ©ation connexion peer avec ${userId}`);
    const pc = new RTCPeerConnection({
      iceServers: [{ urls: ['stun:stun.l.google.com:19302'] }]
    });
    
    // Ajouter les tracks locaux
    if (this.localStream) {
      this.localStream.getTracks().forEach(track => {
        pc.addTrack(track, this.localStream);
      });
    }
    
    // Recevoir les tracks distants
    pc.ontrack = (event) => {
      console.log(`ğŸµ Track reÃ§u de ${userId}`);
      const videoTracks = event.streams[0].getVideoTracks();
      if (videoTracks.length > 0) {
        // C'est un stream vidÃ©o (Ã©cran partagÃ©)
        const remoteVideo = q('#remoteStream');
        if (remoteVideo) {
          remoteVideo.srcObject = event.streams[0];
          console.log('ğŸ“º Affichage du stream Ã©cran');
        }
      } else {
        // C'est l'audio
        this.playRemoteAudio(userId, event.streams[0]);
      }
    };
    
    // Gestion ICE candidates
    pc.onicecandidate = (event) => {
      if (event.candidate) {
        socket.emit('webrtc_ice_candidate', {
          target_user_id: userId,
          sender_user_id: S.me.id,
          channel_id: S.activeCh,
          candidate: event.candidate
        });
      }
    };
    
    // Ã‰tat connexion
    pc.onconnectionstatechange = () => {
      console.log(`ğŸ”— Ã‰tat ${userId}: ${pc.connectionState}`);
      if (pc.connectionState === 'failed' || pc.connectionState === 'disconnected') {
        this.removePeer(userId);
      }
    };
    
    this.peers[userId] = pc;
    
    // CrÃ©er une offre
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    
    socket.emit('webrtc_offer', {
      target_user_id: userId,
      sender_user_id: S.me.id,
      channel_id: S.activeCh,
      offer: offer
    });
  },
  
  async handleOffer(fromUserId, offer) {
    let pc = this.peers[fromUserId];
    if (!pc) {
      pc = new RTCPeerConnection({
        iceServers: [{ urls: ['stun:stun.l.google.com:19302'] }]
      });
      this.peers[fromUserId] = pc;
      
      if (this.localStream) {
        this.localStream.getTracks().forEach(track => {
          pc.addTrack(track, this.localStream);
        });
      }
      
      pc.ontrack = (event) => {
        console.log(`ğŸµ Track reÃ§u de ${fromUserId}`);
        const videoTracks = event.streams[0].getVideoTracks();
        if (videoTracks.length > 0) {
          // C'est un stream vidÃ©o (Ã©cran partagÃ©)
          const remoteVideo = q('#remoteStream');
          if (remoteVideo) {
            remoteVideo.srcObject = event.streams[0];
            console.log('ğŸ“º Affichage du stream Ã©cran');
          }
        } else {
          // C'est l'audio
          this.playRemoteAudio(fromUserId, event.streams[0]);
        }
      };
      
      pc.onicecandidate = (event) => {
        if (event.candidate) {
          socket.emit('webrtc_ice_candidate', {
            target_user_id: fromUserId,
            sender_user_id: S.me.id,
            channel_id: S.activeCh,
            candidate: event.candidate
          });
        }
      };
    }
    
    await pc.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    
    socket.emit('webrtc_answer', {
      target_user_id: fromUserId,
      sender_user_id: S.me.id,
      channel_id: S.activeCh,
      answer: answer
    });
  },
  
  async handleAnswer(fromUserId, answer) {
    const pc = this.peers[fromUserId];
    if (pc && pc.signalingState === 'have-local-offer') {
      await pc.setRemoteDescription(new RTCSessionDescription(answer));
    }
  },
  
  async handleIceCandidate(fromUserId, candidate) {
    const pc = this.peers[fromUserId];
    if (pc) {
      try {
        await pc.addIceCandidate(new RTCIceCandidate(candidate));
      } catch(e) {
        console.warn('ICE error:', e);
      }
    }
  },
  
  playRemoteAudio(userId, stream) {
    if (this.audioElements[userId]) return;
    
    const audio = new Audio();
    audio.srcObject = stream;
    audio.autoplay = true;
    audio.playsinline = true;
    document.body.appendChild(audio); // Ajouter au DOM pour que Ã§a joue
    
    this.audioElements[userId] = audio;
    console.log(`ğŸ”Š Lecture audio ${userId}`);
  },
  
  removePeer(userId) {
    const pc = this.peers[userId];
    if (pc) {
      pc.close();
      delete this.peers[userId];
      console.log(`â– Connexion ${userId} fermÃ©e`);
    }
    
    const audio = this.audioElements[userId];
    if (audio) {
      audio.pause();
      audio.srcObject = null;
      audio.remove();
      delete this.audioElements[userId];
    }
  },
  
  cleanup() {
    Object.keys(this.peers).forEach(userId => this.removePeer(userId));
    if (this.localStream) {
      this.localStream.getTracks().forEach(track => track.stop());
      this.localStream = null;
    }
  },
  
  screenStream: null,  // Pour le screen sharing
  
  async startScreenShare() {
    try {
      console.log('ğŸ“º Demande permission screen...');
      this.screenStream = await navigator.mediaDevices.getDisplayMedia({
        video: { cursor: 'always' },
        audio: false
      });
      
      console.log('âœ… Screen partage activÃ©');
      
      // Remplacer les video tracks de tous les peers avec le screen
      const videoTrack = this.screenStream.getVideoTracks()[0];
      
      Object.values(this.peers).forEach(pc => {
        const sender = pc.getSenders().find(s => s.track?.kind === 'video');
        if (sender) {
          sender.replaceTrack(videoTrack);
        } else {
          pc.addTrack(videoTrack, this.screenStream);
        }
      });
      
      // ArrÃªter le screen quand l'utilisateur arrÃªte de partager
      videoTrack.onended = () => {
        console.log('ğŸ“º Screen partage arrÃªtÃ©');
        this.stopScreenShare();
      };
      
      // Notifier les autres qu'on partage
      socket.emit('voice_streaming_started', {
        channel_id: S.activeCh,
        user_id: S.me.id,
        name: S.me.name || 'Utilisateur'
      });
      
      return true;
    } catch(e) {
      console.error('âŒ Erreur screen share:', e);
      if (e.name !== 'NotAllowedError') {
        alert('Erreur lors du partage d\'Ã©cran');
      }
      return false;
    }
  },
  
  async stopScreenShare() {
    if (this.screenStream) {
      this.screenStream.getTracks().forEach(track => track.stop());
      this.screenStream = null;
      
      // Revenir au microphone
      if (this.localStream) {
        const audioTrack = this.localStream.getAudioTracks()[0];
        Object.values(this.peers).forEach(pc => {
          const sender = pc.getSenders().find(s => s.track?.kind === 'audio');
          if (sender && audioTrack) {
            sender.replaceTrack(audioTrack);
          }
        });
      }
      
      // Notifier les autres qu'on arrÃªte de partager
      socket.emit('voice_streaming_stopped', {
        channel_id: S.activeCh,
        user_id: S.me.id,
        name: S.me.name || 'Utilisateur'
      });
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VOICE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function joinVoice(id){
  const ch=S.activeSrv?.channels.find(c=>c.id===id);
  // Charger les vrais membres du serveur pour le canal vocal
  const voiceMembers = S.activeSrv?.members || [];
  S.inVoice={
    id,
    name:ch?.name||'Vocal',
    muted:false,
    deafened:false,
    streaming:false,
    members: voiceMembers.map(m => ({
      user_id: m.user_id,
      name: m.name || m.username,
      avatar: m.avatar,
      color: m.color || '#94a3b8',
      status: m.status || 'online',
      role: m.role || 'Membre'
    }))
  };
  S.activeCh=id;
  renderChannels();
  renderVoiceControls();
  updateTitlebar('Vocal: '+S.inVoice.name);
  
  // Initialiser WebRTC
  (async () => {
    const success = await WebRTC.init();
    if (success) {
      // Notifier les autres utilisateurs et crÃ©er des connexions
      socket.emit('voice_channel_join', {
        user_id: S.me.id,
        channel_id: id,
        server_id: S.activeSrv.id
      });
      
      // Se connecter Ã  tous les autres utilisateurs du canal
      voiceMembers.forEach(m => {
        if (m.user_id !== S.me.id) {
          setTimeout(() => WebRTC.addPeer(m.user_id), 500);
        }
      });
    }
  })();
}
function leaveVoice(){
  // Nettoyer WebRTC
  WebRTC.cleanup();
  
  // Notifier le serveur
  if (S.inVoice) {
    socket.emit('voice_channel_leave', {
      user_id: S.me.id,
      channel_id: S.inVoice.id
    });
  }
  
  S.inVoice=null;S.activeCh=null;
  renderChannels();
  q('#voicePanel')?.remove();
  updateTitlebar('Accueil');
}
function toggleMute(){
  if(!S.inVoice)return;
  S.inVoice.muted=!S.inVoice.muted;
  // DÃ©sactiver/Activer les tracks audio
  if(WebRTC.localStream) {
    WebRTC.localStream.getAudioTracks().forEach(track => {
      track.enabled = !S.inVoice.muted;
    });
  }
  // Notifier les autres utilisateurs du canal
  if(socket && S.activeCh) {
    socket.emit('voice_mute_changed', {
      user_id: S.me.id,
      channel_id: S.activeCh,
      muted: S.inVoice.muted
    });
  }
  renderVoiceControls();
}
function toggleDeafen(){
  if(!S.inVoice)return;
  S.inVoice.deafened=!S.inVoice.deafened;
  if(S.inVoice.deafened)S.inVoice.muted=true;
  // Mute aussi si deafened
  if(WebRTC.localStream) {
    WebRTC.localStream.getAudioTracks().forEach(track => {
      track.enabled = !S.inVoice.muted;
    });
  }
  // DÃ©sactiver l'audio des autres utilisateurs quand deafened
  Object.values(WebRTC.audioElements).forEach(audio => {
    audio.volume = S.inVoice.deafened ? 0 : 1;
  });
  // Notifier les autres utilisateurs du canal
  if(socket && S.activeCh) {
    socket.emit('voice_deafen_changed', {
      user_id: S.me.id,
      channel_id: S.activeCh,
      deafened: S.inVoice.deafened
    });
  }
  renderVoiceControls();
}
function toggleStream(){
  if(!S.inVoice)return;
  
  if(S.inVoice.streaming) {
    // ArrÃªter le screen sharing
    WebRTC.stopScreenShare();
    S.inVoice.streaming = false;
    showToast('ğŸ“º Partage d\'Ã©cran arrÃªtÃ©');
  } else {
    // DÃ©marrer le screen sharing
    (async () => {
      const success = await WebRTC.startScreenShare();
      if(success) {
        S.inVoice.streaming = true;
        showToast('ğŸ“º Ã‰cran partagÃ© avec le canal !');
      }
      renderVoiceControls();
    })();
  }
  
  renderVoiceControls();
}
function renderVoiceControls(){
  let panel=q('#voicePanel');
  if(!S.inVoice){
    if(panel)panel.remove();
    return;
  }
  if(!panel){
    panel=document.createElement('div');
    panel.id='voicePanel';
    panel.className='voice-panel';
    q('#messages')?.parentElement.insertBefore(panel,q('#messages'));
  }
  
  // Trouver si quelqu'un stream
  const streamer = S.inVoice.members.find(m => m.streaming);
  const otherMembers = S.inVoice.members.filter(m => m.user_id !== S.me.id);
  
  const streamContent = streamer ? `
    <div class="voice-stream-container">
      <video id="remoteStream" autoplay playsinline style="width:100%;height:100%;object-fit:contain;background:#000"></video>
      <div class="stream-badge">
        <span>ğŸ“º ${streamer.name} partage son Ã©cran</span>
      </div>
    </div>
  ` : `
    <div class="voice-no-stream">
      <div style="font-size:48px;margin-bottom:20px">ğŸ¤</div>
      <div style="font-size:16px;font-weight:600;color:var(--text)">Canal vocal actif</div>
      <div style="font-size:13px;color:var(--text4);margin-top:8px">${S.inVoice.members.length} personne(s) connectÃ©e(s)</div>
    </div>
  `;
  
  // Afficher les vrais membres avec couleur et statut
  const members=otherMembers.map(m=>{
    const avatar = typeof m.avatar === 'string' ? m.avatar : 'ğŸ‘¤';
    return `
    <div class="voice-member-item">
      <div class="vm-avatar" style="background:${m.color||'#94a3b8'}20;border:2px solid ${m.color||'#94a3b8'};">
        <span>${avatar.charAt(0) === 'h' ? 'ğŸ“·' : avatar}</span>
      </div>
      <div class="vm-info">
        <div class="vm-name">${m.name||'Unknown'}</div>
        <div class="vm-status">
          ${m.streaming?'ğŸ“º En stream':(m.muted?'ğŸ”‡ Muet':'ğŸ¤ En vocal')}
        </div>
      </div>
      <div class="vm-icon">${m.streaming?'ğŸ“º':(m.muted?'ğŸ”‡':'ğŸ¤')}</div>
    </div>`;
  }).join('');
  
  // Status de l'utilisateur courant
  const statusIcon = S.inVoice.muted ? 'ğŸ”‡' : (S.inVoice.deafened ? 'ğŸ”Š' : 'ğŸ¤');
  const statusText = S.inVoice.muted ? 'Microphone coupÃ©' : (S.inVoice.deafened ? 'Muet' : 'Microphone actif');
  const statusColor = S.inVoice.muted ? '#ef4444' : '#10b981';
  
  panel.innerHTML=`
    <div class="voice-main">
      ${streamContent}
      
      <div class="voice-sidebar">
        <div class="voice-sidebar-header">
          <div>Participants</div>
          <div style="font-size:12px;color:var(--text4)">${S.inVoice.members.length}</div>
        </div>
        
        <div class="voice-members-list">
          <div class="voice-member-item voice-self">
            <div class="vm-avatar" style="background:var(--accent)30;border:2px solid var(--accent);">
              <span>${S.me.avatar?.charAt(0) === 'h' ? 'ğŸ‘¤' : (S.me.avatar || 'ğŸ‘¤')}</span>
            </div>
            <div class="vm-info">
              <div class="vm-name">${S.me.name||'Toi'}</div>
              <div class="vm-status" style="color:${statusColor}">${statusText}</div>
            </div>
            <div class="vm-icon" style="color:${statusColor}">${statusIcon}</div>
          </div>
          
          ${members}
        </div>
      </div>
    </div>
    
    <div class="voice-footer">
      <div class="voice-footer-left">
        <div class="voice-info">
          <span style="font-size:16px">ğŸ”Š</span>
          <div>
            <div style="font-weight:600;font-size:13px">${S.inVoice.name}</div>
            <div style="font-size:11px;color:var(--text4)">${S.inVoice.members.length} connectÃ©(s)</div>
          </div>
        </div>
      </div>
      
      <div class="voice-controls">
        <button class="voice-btn ${S.inVoice.muted?'active':''}" onclick="toggleMute()" title="Micro">
          <span>${S.inVoice.muted?'ğŸ”‡':'ğŸ™'}</span>
        </button>
        <button class="voice-btn ${S.inVoice.deafened?'active':''}" onclick="toggleDeafen()" title="Casque">
          <span>${S.inVoice.deafened?'ğŸ”Š':'ğŸ§'}</span>
        </button>
        <button class="voice-btn ${S.inVoice.streaming?'active streaming':''}" onclick="toggleStream()" title="Partager Ã©cran" id="streamBtn">
          <span>ğŸ“¹</span>
        </button>
        <button class="voice-btn leave" onclick="leaveVoice()" title="Quitter">
          <span>ğŸ“</span>
        </button>
      </div>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SERVERS / CHANNELS MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function createServer(){
  const name=q('#srvName')?.value.trim();if(!name)return;
  const emoji=q('#srvEmoji')?.value.trim()||'ğŸŒ';
  const token=localStorage.getItem('likoo_token');
  if(!token){
    alert('Vous devez Ãªtre connectÃ© pour crÃ©er un serveur');
    return;
  }
  try{
    const r=await fetch('http://localhost:5000/api/servers',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},
      body:JSON.stringify({name,icon:emoji})
    });
    const srv=await r.json();
    if(!r.ok){
      throw new Error(srv.error || `HTTP ${r.status}`);
    }
    const newSrv={
      id:srv.id,name:srv.name,emoji:srv.icon||emoji,owner_id:srv.owner_id,
      channels:(srv.channels||[]).map(ch=>({id:ch.id,name:ch.name,type:ch.type||'text',desc:ch.description||'',notif:0})),
      members:[]
    };
    S.servers.push(newSrv);
    q('#srvName').value='';q('#srvEmoji').value='';
    closeModal('modalCreateServer');renderNav();selectServer(newSrv.id);
  }catch(e){
    console.error('createServer error:',e);
    alert('Erreur: '+e.message);
  }
}

// Server Settings
function openServerSettings(){
  if(!S.activeSrv)return;
  const isOwner = S.activeSrv.owner_id === S.me.id;
  if(!isOwner){
    alert('Seul le propriÃ©taire du serveur peut modifier les paramÃ¨tres');
    return;
  }
  
  // Charger les donnÃ©es FRAÃCHES du serveur depuis l'API
  console.log('ğŸ“¥ Chargement des donnÃ©es fraÃ®ches du serveur...');
  fetch(`/api/servers/${S.activeSrv.id}`, {
    headers: { 'Authorization': `Bearer ${localStorage.getItem('likoo_token')}` }
  })
  .then(r => r.json())
  .then(data => {
    console.log('âœ… DonnÃ©es du serveur mises Ã  jour:', data);
    // Mettre Ã  jour S.activeSrv avec les donnÃ©es fraÃ®ches
    S.activeSrv = data;
    
    // Remplir le formulaire
    q('#serverSettingsName').value = S.activeSrv.name || '';
    q('#serverSettingsDesc').value = S.activeSrv.description || '';
    updateServerIconPreview();
    clearServerSettingsMessages();
    switchServerTab('profile');
    openModal('modalServerSettings');
  })
  .catch(err => {
    console.error('âŒ Erreur lors du chargement du serveur:', err);
    alert('Erreur lors du chargement des paramÃ¨tres');
  });
}

function updateSettingsButtonVisibility(){
  const btn = q('#serverSettingsBtn');
  if(!btn)return;
  const isOwner = S.activeSrv && S.activeSrv.owner_id === S.me.id;
  btn.style.display = isOwner ? 'block' : 'none';
}

function clearServerSettingsMessages() {
  const errEl = q('#serverSettingsError');
  const sucEl = q('#serverSettingsSuccess');
  const roleErrEl = q('#rolesError');
  if (errEl) errEl.style.display = 'none';
  if (sucEl) sucEl.style.display = 'none';
  if (roleErrEl) roleErrEl.style.display = 'none';
}

function switchServerTab(tabName) {
  // Masquer tous les onglets
  qa('.settings-tab-content').forEach(el => el.style.display = 'none');
  
  // DÃ©sactiver tous les boutons
  qa('.srv-settings-tab-btn').forEach(btn => btn.classList.remove('active'));
  
  // Afficher l'onglet sÃ©lectionnÃ©
  const tabEl = q('#tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
  if (tabEl) tabEl.style.display = 'block';
  
  // Activer le bouton
  const btnId = 'tabBtn' + tabName.charAt(0).toUpperCase() + tabName.slice(1);
  const btn = q('#' + btnId);
  if (btn) btn.classList.add('active');
  
  // Charger les donnÃ©es selon l'onglet
  if (tabName === 'roles') {
    loadServerRoles();
  } else if (tabName === 'members') {
    loadServerMembers();
  } else if (tabName === 'channels') {
    loadServerChannels();
  }
}

function loadServerMembers() {
  const list = q('#settingsMembers');
  if (!list || !S.activeSrv) {
    console.warn('loadServerMembers: list ou activeSrv manquant');
    return;
  }
  
  console.log('ğŸ“¥ Chargement membres du serveur:', S.activeSrv.id);
  
  // Les membres sont dÃ©jÃ  dans S.activeSrv.members
  const members = S.activeSrv.members || [];
  console.log('âœ… Membres trouvÃ©s:', members.length, members);
  
  if (!Array.isArray(members) || members.length === 0) {
    list.innerHTML = '<p style="color:var(--text4);text-align:center;padding:30px;font-size:14px">Aucun membre (seul propriÃ©taire pour l\'instant)</p>';
    return;
  }
  
  let html = '';
  members.forEach(m => {
    const avatarHtml = formatAvatar(m.avatar || m.av || 'ğŸ‘¤');
    const joinDate = m.joined_at ? new Date(m.joined_at).toLocaleDateString('fr') : 'Date inconnue';
    html += `
      <div style="padding:12px 14px;background:var(--bg);border-radius:8px;display:flex;align-items:center;gap:12px;margin-bottom:8px;overflow:hidden;box-sizing:border-box">
        <div style="width:44px;height:44px;border-radius:8px;background:var(--bg2);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;overflow:hidden">${avatarHtml}</div>
        <div style="flex:1;min-width:0;overflow:hidden">
          <div style="font-weight:600;font-size:14px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${m.name || m.username || 'Unknown'}</div>
          <div style="font-size:12px;color:var(--text4);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">Rejoint le ${joinDate}</div>
        </div>
      </div>
    `;
  });
  list.innerHTML = html;
}

function loadServerChannels() {
  const list = q('#settingsChannels');
  if (!list || !S.activeSrv) {
    console.warn('loadServerChannels: list ou activeSrv manquant');
    return;
  }
  
  console.log('ğŸ“¥ Chargement salons du serveur:', S.activeSrv.id);
  
  // Les salons sont dÃ©jÃ  dans S.activeSrv.channels
  const channels = S.activeSrv.channels || [];
  console.log('âœ… Salons trouvÃ©s:', channels.length, channels);
  
  if (!Array.isArray(channels) || channels.length === 0) {
    list.innerHTML = '<p style="color:var(--text4);text-align:center;padding:30px;font-size:14px">Aucun salon</p>';
    return;
  }
  
  // SÃ©parer les salons par type
  const textChannels = channels.filter(ch => ch.type !== 'voice');
  const voiceChannels = channels.filter(ch => ch.type === 'voice');
  
  let html = '';
  
  // Section SALONS (text)
  if (textChannels.length > 0) {
    html += '<div style="margin-bottom:28px">';
    html += '<div style="font-size:11px;font-weight:800;color:var(--text4);text-transform:uppercase;letter-spacing:1.2px;padding:12px 0 12px 0;border-bottom:1px solid var(--border)">SALONS</div>';
    textChannels.forEach(ch => {
      html += `<div style="padding:10px 12px;display:flex;align-items:center;gap:10px;margin-bottom:6px;cursor:pointer;border-radius:6px;transition:background 0.2s" onmouseover="this.style.background='var(--bg2)'" onmouseout="this.style.background='transparent'"><div style="font-size:16px;flex-shrink:0">${ch.type === 'announce' ? 'ğŸ“¢' : '#'}</div><div style="flex:1;min-width:0;overflow:hidden"><div style="font-weight:500;color:var(--text);font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${ch.name}</div></div></div>`;
    });
    html += '</div>';
  }
  
  // Section VOCAUX (voice)
  if (voiceChannels.length > 0) {
    html += '<div>';
    html += '<div style="font-size:11px;font-weight:800;color:var(--text4);text-transform:uppercase;letter-spacing:1.2px;padding:12px 0 12px 0;border-bottom:1px solid var(--border)">VOCAUX</div>';
    voiceChannels.forEach(ch => {
      html += `<div style="padding:10px 12px;display:flex;align-items:center;gap:10px;margin-bottom:6px;cursor:pointer;border-radius:6px;transition:background 0.2s" onmouseover="this.style.background='var(--bg2)'" onmouseout="this.style.background='transparent'"><div style="font-size:16px;flex-shrink:0">ğŸ”Š</div><div style="flex:1;min-width:0;overflow:hidden"><div style="font-weight:500;color:var(--text);font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${ch.name}</div></div></div>`;
    });
    html += '</div>';
  }
  
  list.innerHTML = html;
}

function updateServerIconPreview() {
  const preview = q('#serverIconPreview');
  if (!preview) return;
  
  if (S.activeSrv.icon_image) {
    preview.style.fontSize = '0';
    preview.innerHTML = `<img src="${S.activeSrv.icon_image}" style="width:100%;height:100%;border-radius:16px;object-fit:cover" alt="icon">`;
  } else {
    preview.style.fontSize = '32px';
    preview.innerHTML = S.activeSrv.emoji || 'ğŸ ';
  }
}

function handleServerIconUpload(input) {
  const file = input.files[0];
  if (!file) return;
  
  if (!file.type.startsWith('image/')) {
    showServerError('Veuillez sÃ©lectionner une image');
    return;
  }
  if (file.size > 5 * 1024 * 1024) {
    showServerError('L\'image ne doit pas dÃ©passer 5 MB');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = e => {
    const preview = q('#serverIconPreview');
    preview.style.fontSize = '0';
    preview.innerHTML = `<img src="${e.target.result}" style="width:100%;height:100%;border-radius:16px;object-fit:cover" alt="preview">`;
    input.dataset.processed = 'true';
  };
  reader.readAsDataURL(file);
}

function saveServerSettings() {
  const name = q('#serverSettingsName').value.trim();
  const desc = q('#serverSettingsDesc').value.trim();
  const iconInput = q('#serverIconInput');
  
  if (!name) {
    showServerError('Le nom du serveur est obligatoire');
    return;
  }
  
  if (!S.activeSrv) {
    showServerError('Aucun serveur sÃ©lectionnÃ©');
    return;
  }
  
  const token = localStorage.getItem('likoo_token');
  if (!token) {
    showServerError('Non authentifiÃ©');
    return;
  }
  
  // Fonction pour sauvegarder les paramÃ¨tres
  const doSave = () => {
    fetch(`http://localhost:5000/api/servers/${S.activeSrv.id}`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({ name, description: desc })
    })
    .then(r => r.json())
    .then(data => {
      if (data.error) {
        showServerError(data.error);
        return;
      }
      S.activeSrv.name = name;
      S.activeSrv.description = desc;
      showServerSuccess('ParamÃ¨tres enregistrÃ©s avec succÃ¨s');
      renderNav();
      renderChannels();
      setTimeout(() => closeModal('modalServerSettings'), 1500);
    })
    .catch(err => {
      console.error('Error:', err);
      showServerError('Erreur lors de la sauvegarde');
    });
  };
  
  // VÃ©rifier si un fichier a Ã©tÃ© sÃ©lectionnÃ©
  if (iconInput && iconInput.files.length > 0) {
    const formData = new FormData();
    formData.append('icon', iconInput.files[0]);
    
    fetch(`http://localhost:5000/api/servers/${S.activeSrv.id}/upload-icon`, {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + token
      },
      body: formData
    })
    .then(r => r.json())
    .then(data => {
      if (data.error) {
        showServerError(data.error);
        return;
      }
      if (data.icon_image) {
        S.activeSrv.icon_image = data.icon_image;
      }
      // Sauvegarder les autres paramÃ¨tres aprÃ¨s upload de l'icÃ´ne
      doSave();
    })
    .catch(err => {
      console.error('Icon upload error:', err);
      showServerError('Erreur lors de l\'upload de l\'icÃ´ne');
    });
  } else {
    // Pas de fichier, juste sauvegarder les paramÃ¨tres
    doSave();
  }
}

function showServerError(msg) {
  const el = q('#serverSettingsError');
  if (el) {
    el.textContent = msg;
    el.style.display = 'block';
  }
  const sucEl = q('#serverSettingsSuccess');
  if (sucEl) sucEl.style.display = 'none';
}

function showServerSuccess(msg) {
  const el = q('#serverSettingsSuccess');
  if (el) {
    el.textContent = msg;
    el.style.display = 'block';
  }
  const errEl = q('#serverSettingsError');
  if (errEl) errEl.style.display = 'none';
}

function loadServerRoles() {
  const token = localStorage.getItem('likoo_token');
  if (!token || !S.activeSrv) return;
  
  fetch(`/api/servers/${S.activeSrv.id}/roles`, {
    headers: { 'Authorization': 'Bearer ' + token }
  })
  .then(r => r.json())
  .then(roles => {
    const rolesList = q('#rolesList');
    if (!rolesList) return;
    
    if (!Array.isArray(roles) || roles.length === 0) {
      rolesList.innerHTML = '<p style="color:var(--text4);text-align:center;padding:20px">Aucun rÃ´le crÃ©Ã©</p>';
      return;
    }
    
    let html = '';
    roles.forEach(role => {
      const perms = Object.entries(role.permissions || {}).filter(([k,v]) => v).map(([k]) => k).join(', ');
      html += `
        <div style="border:1.5px solid var(--border2);border-radius:8px;padding:14px;display:flex;justify-content:space-between;align-items:center;background:var(--bg)">
          <div style="display:flex;align-items:center;gap:12px;flex:1">
            <div style="width:24px;height:24px;background-color:${role.color || '#8b5cf6'};border-radius:6px;flex-shrink:0"></div>
            <div style="flex:1;min-width:0">
              <div style="font-weight:600;color:var(--text);font-size:14px">${role.name}</div>
              <div style="font-size:11px;color:var(--text4);margin-top:4px;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden">${perms || 'Pas de permissions'}</div>
            </div>
          </div>
          <div style="display:flex;gap:8px;flex-shrink:0">
            <button class="btn btn-ghost" style="padding:6px 12px;font-size:12px;border-radius:6px">âœ</button>
            <button class="btn" style="padding:6px 12px;font-size:12px;background:#f87171;color:#7f1d1d;border:none;border-radius:6px;cursor:pointer;font-weight:600" onclick="deleteRole('${role.id}')">ğŸ—‘ï¸</button>
          </div>
        </div>
      `;
    });
    
    rolesList.innerHTML = html;
  })
  .catch(err => {
    console.error('Erreur chargement rÃ´les:', err);
    const el = q('#rolesError');
    if (el) {
      el.textContent = 'Erreur lors du chargement des rÃ´les';
      el.style.display = 'block';
    }
  });
}

function addNewRole() {
  const rolesList = q('#rolesList');
  if (!rolesList || rolesList.querySelector('[data-form="create-role"]')) return;
  
  const permissions = {
    manage_server: true,
    manage_roles: false,
    manage_channels: false,
    manage_members: false,
    send_messages: true,
    send_files: false,
    mention_everyone: false,
    manage_messages: false,
    mute_members: false
  };
  
  let permissionsHTML = '';
  Object.entries(permissions).forEach(([key, defaultVal]) => {
    const label = key.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
    permissionsHTML += `
      <label style="display:flex;align-items:center;gap:8px;font-size:12px;margin-bottom:8px">
        <input type="checkbox" class="perm-checkbox" data-perm="${key}" ${defaultVal ? 'checked' : ''}>
        ${label}
      </label>
    `;
  });
  
  const formHTML = `
    <div data-form="create-role" style="border:2px solid #8b5cf6;border-radius:8px;padding:12px;background:#f9f3ff">
      <h4 style="margin:0 0 12px 0;font-size:14px">Nouveau RÃ´le</h4>
      <div style="margin-bottom:12px">
        <label style="font-size:12px;font-weight:700;color:#666">Nom</label>
        <input type="text" id="newRoleName" placeholder="Ex: ModÃ©rateur" maxlength="50" style="width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;margin-top:4px;font-size:12px;box-sizing:border-box">
      </div>
      <div style="margin-bottom:12px">
        <label style="font-size:12px;font-weight:700;color:#666">Couleur</label>
        <input type="color" id="newRoleColor" value="#8b5cf6" style="width:100%;height:32px;border:1px solid #ddd;border-radius:4px;cursor:pointer;margin-top:4px">
      </div>
      <div style="margin-bottom:12px">
        <label style="font-size:12px;font-weight:700;color:#666;display:block;margin-bottom:8px">Permissions</label>
        <div style="background:white;padding:8px;border-radius:4px;border:1px solid #ddd">
          ${permissionsHTML}
        </div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn btn-ghost" onclick="cancelNewRole()" style="padding:6px 12px;font-size:12px">Annuler</button>
        <button class="btn btn-primary" onclick="createRole()" style="padding:6px 12px;font-size:12px">CrÃ©er</button>
      </div>
    </div>
  `;
  
  rolesList.insertAdjacentHTML('afterbegin', formHTML);
  q('#newRoleName').focus();
}

function cancelNewRole() {
  const form = q('[data-form="create-role"]');
  if (form) form.remove();
}

async function createRole() {
  const name = q('#newRoleName').value.trim();
  const color = q('#newRoleColor').value;
  
  if (!name) {
    alert('Le nom du rÃ´le est obligatoire');
    return;
  }
  
  const permissions = {};
  qa('.perm-checkbox').forEach(cb => {
    permissions[cb.dataset.perm] = cb.checked;
  });
  
  const token = localStorage.getItem('likoo_token');
  if (!token || !S.activeSrv) return;
  
  try {
    const r = await fetch(`http://localhost:5000/api/servers/${S.activeSrv.id}/roles`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({ name, color, permissions })
    });
    
    const data = await r.json();
    if (data.error) {
      alert('Erreur: ' + data.error);
      return;
    }
    
    cancelNewRole();
    loadServerRoles();
  } catch (err) {
    console.error('Error:', err);
    alert('Erreur lors de la crÃ©ation du rÃ´le');
  }
}

async function deleteRole(roleId) {
  if (!confirm('ÃŠtes-vous sÃ»r?')) return;
  
  const token = localStorage.getItem('likoo_token');
  if (!token || !S.activeSrv) return;
  
  try {
    const r = await fetch(`http://localhost:5000/api/servers/${S.activeSrv.id}/roles/${roleId}`, {
      method: 'DELETE',
      headers: { 'Authorization': 'Bearer ' + token }
    });
    
    const data = await r.json();
    if (data.error) {
      alert('Erreur: ' + data.error);
      return;
    }
    
    loadServerRoles();
  } catch (err) {
    console.error('Error:', err);
    alert('Erreur lors de la suppression');
  }
}

let newChType='text';
function selChType(el){document.querySelectorAll('.chip').forEach(c=>c.classList.remove('sel'));el.classList.add('sel');newChType=el.dataset.type;}
async function createChannel(){
  if(!S.activeSrv)return;
  const name=q('#newChName')?.value.trim().toLowerCase().replace(/\s+/g,'-')||'nouveau';
  const token=localStorage.getItem('likoo_token');
  try{
    const r=await fetch(`http://localhost:5000/api/servers/${S.activeSrv.id}/channels`,{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},
      body:JSON.stringify({name,type:newChType})
    });
    if(r.status===403){alert('Seul le propriÃ©taire du serveur peut crÃ©er des salons.');return;}
    if(!r.ok)throw new Error('failed');
    const ch=await r.json();
    S.activeSrv.channels.push({id:ch.id,name:ch.name,type:ch.type,desc:ch.description||'',notif:0});
    q('#newChName').value='';closeModal('modalCreateChannel');renderChannels();
  }catch(e){console.error('createChannel:',e);alert('Erreur lors de la crÃ©ation du salon.');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EMOJI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildEmoji(){
  const el=q('#emojiPicker');if(!el)return;
  el.innerHTML=`<div class="emoji-grid">${EMOJIS.map(e=>`<button class="emoji-cell" onclick="insEmoji('${e}')">${e}</button>`).join('')}</div>`;
}
function toggleEmoji(){q('#emojiPicker')?.classList.toggle('open');}
function insEmoji(e){const i=q('#msgInput');if(i){i.value+=e;i.focus();}q('#emojiPicker')?.classList.remove('open');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id){q(`#${id}`)?.classList.add('open');}
function closeModal(id){q(`#${id}`)?.classList.remove('open');}
function openSettings(){
  if(S.me){
    q('#setName').value=S.me.name;
    selectedAvatar = S.me.av || S.me.avatar || 'ğŸ‘¤';
    // show preview if image
    const prev=q('#avatarPreview');
    if(prev){
      // treat http, /, data: and blob: URIs as images
      if(selectedAvatar.startsWith('http') || selectedAvatar.startsWith('/') 
         || selectedAvatar.startsWith('data:') || selectedAvatar.startsWith('blob:')){
        prev.innerHTML=`<img src="${selectedAvatar}">`;
      } else {
        prev.innerHTML=`<span style="font-size:24px">${selectedAvatar}</span>`;
      }
    }
  }
  openModal('modalSettings');
}

function saveSettings(){
  // close modal as soon as user clicks save
  closeModal('modalSettings');
  if(S.me){
    const n=q('#setName')?.value.trim()||S.me.name;
    S.me.name=n;
    // if a new avatar was chosen but uploadAvatar onload hasn't run yet,
    // make sure we still apply it (data/blob URL or final value)
    if(selectedAvatar && (selectedAvatar.startsWith('http')||selectedAvatar.startsWith('/')
        || selectedAvatar.startsWith('data:')||selectedAvatar.startsWith('blob:'))){
      S.me.av = selectedAvatar;
    }
    // persist changes to server if logged in
    const _settingsToken = localStorage.getItem('likoo_token');
    if(_settingsToken){
      fetch('http://localhost:5000/api/auth/me',{
        method:'PATCH',
        headers:{
          'Content-Type':'application/json',
          'Authorization':'Bearer '+_settingsToken
        },
        body: JSON.stringify({ username: S.me.name, avatar: S.me.av })
      }).catch(console.error);
    }
    save();
    updateNavAv();
    q('#navName').innerHTML = `<div>${S.me.name}</div><div style="font-size:11px;opacity:0.7">#${S.me.tag}</div>`;
    renderServers();
    renderMembers();
  }
  localStorage.setItem('likoo_theme',S.theme);
  localStorage.setItem('likoo_layout',S.layout);
  closeModal('modalSettings');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS: STATUS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setStatus(el){
  document.querySelectorAll('.st-chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  const s=el.dataset.status;if(!S.me)return;S.me.status=s;save();
  const colors={online:'var(--green)',away:'#f59e0b',dnd:'var(--red)',offline:'#7f8c8d'};
  ['navStatusDot'].forEach(id=>{const d=q('#'+id);if(d){d.className='st-dot '+s;d.style.background=colors[s];}});
  // Mettre Ã  jour le statut dans la liste des membres aussi
  if(S.activeSrv && S.activeSrv.members){
    S.activeSrv.members.forEach(m => {
      if(m.user_id === S.me.id) m.status = s;
    });
    renderMembers();
  }
  // Sauvegarder le statut dans la base de donnÃ©es (asynchrone)
  fetch('/api/auth/me', {
    method: 'PATCH',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${localStorage.getItem('likoo_token')}`
    },
    body: JSON.stringify({status: s})
  }).catch(err => console.error('Erreur sauvegarde statut:', err));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS: THEMES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const THEME_MAP={
  amber:{bg:'#faf6ef',bg2:'#f2ebe0',bg3:'#e8dece',bg4:'#dfd3be',panel:'#ece8f6',panel2:'#e3ddf2',accent:'#e8850a',accent2:'#f5a033',accent3:'#fbbf60',nav:'#5c3d1e',nav2:'#7a5230',text:'#2c1a08',text2:'#6b4a28',text3:'#a07850',text4:'#c4a882',border:'rgba(92,61,30,0.12)',border2:'rgba(92,61,30,0.22)',shadow:'rgba(92,61,30,0.10)',red:'#c0392b',green:'#27ae60',hl:'rgba(232,133,10,0.15)',hlb:'rgba(232,133,10,0.5)'},
  violet:{bg:'#f0edf8',bg2:'#e8e3f5',bg3:'#ddd6f0',bg4:'#cfc7e8',panel:'#ece8f6',panel2:'#e3ddf2',accent:'#8b5cf6',accent2:'#a78bfa',accent3:'#c4b5fd',nav:'#3b1f6e',nav2:'#4c2d87',text:'#1e1033',text2:'#4a3a72',text3:'#8b7ab8',text4:'#b8acd6',border:'rgba(139,92,246,0.14)',border2:'rgba(139,92,246,0.28)',shadow:'rgba(109,40,217,0.10)',red:'#ef4444',green:'#22c55e',hl:'rgba(139,92,246,0.12)',hlb:'rgba(139,92,246,0.5)'},
  night:{bg:'#0f1117',bg2:'#161922',bg3:'#1e2130',bg4:'#252a3a',panel:'#1a1d2e',panel2:'#20233a',accent:'#38bdf8',accent2:'#7dd3fc',accent3:'#bae6fd',nav:'#090c14',nav2:'#0e1220',text:'#e2e8f0',text2:'#94a3b8',text3:'#64748b',text4:'#475569',border:'rgba(56,189,248,0.12)',border2:'rgba(56,189,248,0.25)',shadow:'rgba(0,0,0,0.3)',red:'#f87171',green:'#4ade80',hl:'rgba(56,189,248,0.10)',hlb:'rgba(56,189,248,0.5)'},
  sakura:{bg:'#fff0f5',bg2:'#ffe4ee',bg3:'#ffd6e5',bg4:'#ffc2d7',panel:'#fce8f1',panel2:'#f9dce8',accent:'#e879a0',accent2:'#f472b6',accent3:'#fbcfe8',nav:'#831843',nav2:'#9d174d',text:'#3b0018',text2:'#831843',text3:'#be185d',text4:'#db2777',border:'rgba(232,121,160,0.15)',border2:'rgba(232,121,160,0.30)',shadow:'rgba(131,24,67,0.10)',red:'#dc2626',green:'#16a34a',hl:'rgba(232,121,160,0.12)',hlb:'rgba(232,121,160,0.55)'},
  forest:{bg:'#0d1f13',bg2:'#122018',bg3:'#182b1e',bg4:'#1f3327',panel:'#162418',panel2:'#1c2e1e',accent:'#4ade80',accent2:'#86efac',accent3:'#bbf7d0',nav:'#052010',nav2:'#063018',text:'#d1fae5',text2:'#6ee7b7',text3:'#34d399',text4:'#10b981',border:'rgba(74,222,128,0.12)',border2:'rgba(74,222,128,0.22)',shadow:'rgba(0,0,0,0.30)',red:'#f87171',green:'#4ade80',hl:'rgba(74,222,128,0.10)',hlb:'rgba(74,222,128,0.5)'},
  golden:{bg:'#fffbeb',bg2:'#fef3c7',bg3:'#fde68a',bg4:'#fcd34d',panel:'#fff8e1',panel2:'#fef0c0',accent:'#d97706',accent2:'#f59e0b',accent3:'#fcd34d',nav:'#78350f',nav2:'#92400e',text:'#3d1a00',text2:'#78350f',text3:'#b45309',text4:'#d97706',border:'rgba(217,119,6,0.15)',border2:'rgba(217,119,6,0.30)',shadow:'rgba(120,53,15,0.10)',red:'#dc2626',green:'#16a34a',hl:'rgba(217,119,6,0.12)',hlb:'rgba(217,119,6,0.55)'},
};

function applyTheme(el){
  const t=el.dataset.theme;
  document.querySelectorAll('.theme-card').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  applyThemeVal(t);
}
function applyThemeVal(t){
  S.theme=t;
  const th=THEME_MAP[t];if(!th)return;
  const r=document.documentElement.style;
  r.setProperty('--bg',th.bg);r.setProperty('--bg2',th.bg2);r.setProperty('--bg3',th.bg3);r.setProperty('--bg4',th.bg4);
  r.setProperty('--panel',th.panel);r.setProperty('--panel2',th.panel2);
  r.setProperty('--accent',th.accent);r.setProperty('--accent2',th.accent2);r.setProperty('--accent3',th.accent3);
  r.setProperty('--nav',th.nav);r.setProperty('--nav2',th.nav2);
  r.setProperty('--text',th.text);r.setProperty('--text2',th.text2);r.setProperty('--text3',th.text3);r.setProperty('--text4',th.text4);
  r.setProperty('--border',th.border);r.setProperty('--border2',th.border2);
  r.setProperty('--shadow',th.shadow);r.setProperty('--red',th.red);r.setProperty('--green',th.green);
  r.setProperty('--zone-hl',th.hl);r.setProperty('--zone-border',th.hlb);
  // Sauvegarder immÃ©diatement le thÃ¨me
  localStorage.setItem('likoo_theme', t);
  // Update theme card active state
  document.querySelectorAll('.theme-card').forEach(c=>{c.classList.toggle('active',c.dataset.theme===t);});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS: LAYOUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
/*
  Layouts dÃ©finissent:
  - grid-template-columns du workspace
  - quel module est dans quelle zone
  - visibilitÃ© des zones
*/
const LAYOUTS = {
  'default':    {cols:'240px 1fr 220px', left:'mod-channels', center:'mod-chat', right:'mod-members', showRight:true},
  'focus':      {cols:'220px 1fr',       left:'mod-channels', center:'mod-chat', right:null,           showRight:false},
  'compact':    {cols:'200px 1fr 180px', left:'mod-channels', center:'mod-chat', right:'mod-members',  showRight:true},
  'wide-chat':  {cols:'1fr 220px',       left:null,           center:'mod-chat', right:'mod-channels', showRight:true},
  'reversed':   {cols:'220px 1fr 240px', left:'mod-members',  center:'mod-chat', right:'mod-channels', showRight:true},
  'minimal':    {cols:'1fr',             left:null,           center:'mod-chat', right:null,           showRight:false},
};

function applyLayout(el){
  const l=el.dataset.layout;
  document.querySelectorAll('.layout-card').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  applyLayoutVal(l);
}
function applyLayoutVal(l){
  S.layout=l;
  const cfg=LAYOUTS[l];if(!cfg)return;
  const ws=q('#workspace');
  ws.style.transition='grid-template-columns .4s cubic-bezier(.4,0,.2,1)';
  ws.style.gridTemplateColumns=cfg.cols;

  const zl=q('#zoneLeft'), zc=q('#zoneCenter'), zr=q('#zoneRight');

  // Show/hide zones
  zl.style.display=(cfg.left||cfg.cols.split(' ').length>1&&cfg.left!==null)?'flex':'none';
  zr.style.display=cfg.showRight?'flex':'none';

  // Move modules to correct zones
  function moveToZone(modId, zoneEl){
    if(!modId||!zoneEl)return;
    const mod=q('#'+modId);
    if(mod&&mod.parentElement!==zoneEl)zoneEl.appendChild(mod);
  }
  if(cfg.left)moveToZone(cfg.left,zl); else zl.style.display='none';
  moveToZone(cfg.center,zc);
  if(cfg.right&&cfg.showRight)moveToZone(cfg.right,zr);

  S.membersVisible=cfg.showRight;

  // Sauvegarder immÃ©diatement le layout
  localStorage.setItem('likoo_layout', l);

  // Update layout card active
  document.querySelectorAll('.layout-card').forEach(c=>c.classList.toggle('active',c.dataset.layout===l));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS: FONT / SIZE / TOGGLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyFont(el){
  document.querySelectorAll('.font-chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  document.documentElement.style.setProperty('--body-font',el.dataset.font);
  document.body.style.fontFamily=el.dataset.font+',sans-serif';
}
function applyFontSize(v){
  q('#fontSizeVal').textContent=v;
  document.documentElement.style.fontSize=v+'px';
}
function toggleAnim(cb){
  S.anim=cb.checked;
  const style=q('#animStyle')||createStyleEl('animStyle');
  style.textContent=S.anim?'':'.msg-group{animation:none!important}';
}
function toggleCompact(cb){S.compact=cb.checked;renderChat();}
function createStyleEl(id){const s=document.createElement('style');s.id=id;document.head.appendChild(s);return s;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAG & DROP MODULES (snap-to-zone)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onModDragStart(e,id){
  S.dragMod=id;
  e.dataTransfer.effectAllowed='move';
  e.dataTransfer.setData('text/plain',id);
  setTimeout(()=>{const m=q('#'+id);if(m)m.classList.add('is-dragging');},0);
  // Highlight all droppable zones
  ['zoneLeft','zoneRight','zoneCenter'].forEach(zid=>{
    const z=q('#'+zid);
    if(z&&z.style.display!=='none')z.setAttribute('data-droppable','1');
  });
}
function onModDragEnd(){
  if(S.dragMod)q('#'+S.dragMod)?.classList.remove('is-dragging');
  S.dragMod=null;
  document.querySelectorAll('.zone').forEach(z=>{z.classList.remove('drop-target');z.removeAttribute('data-droppable');});
}
function onZoneDragOver(e,zone){
  if(!S.dragMod)return;
  e.preventDefault();e.dataTransfer.dropEffect='move';
  const zoneIds={left:'zoneLeft',right:'zoneRight',center:'zoneCenter'};
  const z=q('#'+zoneIds[zone]);
  if(z)z.classList.add('drop-target');
}
function onZoneDragLeave(e,zone){
  const zoneIds={left:'zoneLeft',right:'zoneRight',center:'zoneCenter'};
  const z=q('#'+zoneIds[zone]);
  // Only remove if truly leaving the zone element
  if(z&&!z.contains(e.relatedTarget))z.classList.remove('drop-target');
}
function onZoneDrop(e,zone){
  e.preventDefault();
  const modId=S.dragMod||e.dataTransfer.getData('text/plain');
  const zoneIds={left:'zoneLeft',right:'zoneRight',center:'zoneCenter'};
  const targetZone=q('#'+zoneIds[zone]);
  if(!modId||!targetZone)return;
  const mod=q('#'+modId);
  if(!mod)return;

  // Don't drop on own zone
  if(mod.parentElement===targetZone){
    document.querySelectorAll('.zone').forEach(z=>z.classList.remove('drop-target'));
    return;
  }

  // Swap: if target zone already has a module, swap them
  const existingMod=targetZone.querySelector('.module');
  const sourceZone=mod.parentElement;
  if(existingMod&&sourceZone){
    sourceZone.appendChild(existingMod);
  }
  targetZone.appendChild(mod);

  document.querySelectorAll('.zone').forEach(z=>z.classList.remove('drop-target'));
  S.dragMod=null;

  // Update layout name to 'custom'
  document.querySelectorAll('.layout-card').forEach(c=>c.classList.remove('active'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SERVER SETTINGS HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function deleteServerConfirm() {
  if (!S.activeSrv) {
    showServerError('Aucun serveur sÃ©lectionnÃ©');
    return;
  }
  
  if (S.activeSrv.owner_id !== S.me.id) {
    showServerError('Seul le propriÃ©taire peut supprimer le serveur');
    return;
  }
  
  if (confirm(`ÃŠtes-vous sÃ»r de vouloir supprimer "${S.activeSrv.name}" ? Cette action est irrÃ©versible !`)) {
    const token = localStorage.getItem('likoo_token');
    if (!token) {
      showServerError('Non authentifiÃ©');
      return;
    }
    
    fetch(`http://localhost:5000/api/servers/${S.activeSrv.id}`, {
      method: 'DELETE',
      headers: { 'Authorization': 'Bearer ' + token }
    })
    .then(r => r.json())
    .then(data => {
      if (data.error) {
        showServerError(data.error);
        return;
      }
      S.servers = S.servers.filter(s => s.id !== S.activeSrv.id);
      closeModal('modalServerSettings');
      showHome();
      renderNav();
    })
    .catch(err => {
      console.error('Delete error:', err);
      showServerError('Erreur lors de la suppression');
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MISC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleBtn(b){b.style.opacity=b.style.opacity==='0.4'?'1':'0.4';}
function q(s){return document.querySelector(s);}
function qa(s){return document.querySelectorAll(s);}
function now(){return new Date().toLocaleTimeString('fr',{hour:'2-digit',minute:'2-digit'});}
function rnd(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function fmtB(b){return b<1024?b+' B':b<1048576?(b/1024).toFixed(1)+' KB':(b/1048576).toFixed(1)+' MB';}

// Mobile tab switching (simple show/hide)
function mobSwitch(tab){
  document.querySelectorAll('.mob-tab').forEach(b=>b.classList.remove('active'));
  q('#mobTab'+tab.charAt(0).toUpperCase()+tab.slice(1).charAt(0).toUpperCase()+tab.slice(2))?.classList.add('active');
  const zl=q('#zoneLeft'),zc=q('#zoneCenter'),zr=q('#zoneRight');
  if(!zl||!zc||!zr)return;
  zl.style.display='none';zc.style.display='none';zr.style.display='none';
  if(tab==='servers'){/* handled by showDM/selectServer via channels panel */zl.style.display='flex';}
  else if(tab==='channels'){zl.style.display='flex';}
  else if(tab==='chat'){zc.style.display='flex';}
  else if(tab==='members'){zr.style.display='flex';}
}

// Close overlays/emoji on outside click
document.addEventListener('click',e=>{
  if(!e.target.closest('#emojiPicker')&&!e.target.closest('.inp-btn'))q('#emojiPicker')?.classList.remove('open');
  if(e.target.classList.contains('overlay'))e.target.classList.remove('open');
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TITLEBAR & WINDOW CONTROLS (Electron)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateTitlebar(location){
  const loc=q('#titlebarLocation');
  if(loc)loc.textContent=location;
}

// Window controls
q('#minBtn')?.addEventListener('click',()=>window.electron?.ipc.send('window:minimize'));
q('#maxBtn')?.addEventListener('click',()=>window.electron?.ipc.send('window:maximize'));
q('#closeBtn')?.addEventListener('click',()=>window.electron?.ipc.send('window:close'));

// Initialize titlebar location
updateTitlebar('Accueil');
</script>
</body>
</html>
