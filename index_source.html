<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#8b5cf6">
  <title>Likoo</title>
  <link rel="stylesheet" href="style.css">
  <!-- PWA manifest inline -->
  <link rel="manifest" href="manifest.json">
</head>
<body class="desktop-mode">

<div id="app">

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DESKTOP LAYOUT â€” Floating Panels
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="desktop">

    <!-- â”€â”€ PANEL: Servers â”€â”€ -->
    <div class="panel" id="panel-servers" onclick="bringToFront('panel-servers')">
      <div class="panel-header">
        <div class="panel-controls">
          <div class="panel-ctrl close"    onclick="closePanel('panel-servers')"></div>
          <div class="panel-ctrl minimize" onclick="minimizePanel('panel-servers')"></div>
          <div class="panel-ctrl maximize"></div>
        </div>
        <div class="panel-title">Serveurs</div>
      </div>
      <div class="servers-scroll" id="servers-scroll">
        <!-- rendered by JS -->
      </div>
      <div class="panel-resize"></div>
    </div>

    <!-- â”€â”€ PANEL: Channels â”€â”€ -->
    <div class="panel" id="panel-channels" onclick="bringToFront('panel-channels')">
      <div class="panel-header">
        <div class="panel-controls">
          <div class="panel-ctrl close"    onclick="closePanel('panel-channels')"></div>
          <div class="panel-ctrl minimize" onclick="minimizePanel('panel-channels')"></div>
          <div class="panel-ctrl maximize"></div>
        </div>
        <div class="panel-title" id="server-heading-name">Salons</div>
      </div>
      <div class="server-heading" style="padding:8px 14px 4px">
        <h2 id="server-heading-name2" style="display:none"></h2>
      </div>
      <div class="channels-list" id="channels-list">
        <!-- rendered by JS -->
      </div>
      <div class="user-dock" id="user-dock">
        <!-- rendered by JS -->
      </div>
      <div class="panel-resize"></div>
    </div>

    <!-- â”€â”€ PANEL: Chat â”€â”€ -->
    <div class="panel" id="panel-chat" onclick="bringToFront('panel-chat')">
      <div class="panel-header">
        <div class="panel-controls">
          <div class="panel-ctrl close"    onclick="closePanel('panel-chat')"></div>
          <div class="panel-ctrl minimize" onclick="minimizePanel('panel-chat')"></div>
          <div class="panel-ctrl maximize"></div>
        </div>
        <div class="panel-title">Chat</div>
      </div>

      <!-- Chat topbar -->
      <div class="chat-bar">
        <span id="chat-icon" class="bar-ico">#</span>
        <span id="chat-name" class="ch-label">Likoo</span>
        <span id="chat-desc" style="font-size:11px;color:var(--text4);margin-left:4px"></span>
        <button class="chat-bar-btn" title="Ã‰pingles">ğŸ“Œ</button>
        <button class="chat-bar-btn" title="Membres">ğŸ‘¥</button>
      </div>

      <!-- Messages -->
      <div class="messages-area" id="messages-area">
        <div class="empty-state">
          <div class="big-emoji">ğŸ’œ</div>
          <h3>Likoo</h3>
          <p>Votre espace, vos rÃ¨gles.<br>Rejoignez un serveur ou dÃ©marrez une conversation.</p>
        </div>
      </div>

      <!-- Input area -->
      <div class="input-zone" style="position:relative">
        <div class="emoji-picker" id="emoji-picker"></div>
        <div class="typing-row" id="typing-row"></div>
        <div class="input-row">
          <button class="inp-icon-btn" title="Fichier" onclick="document.getElementById('file-input').click()">ğŸ“</button>
          <input type="file" id="file-input" style="display:none" onchange="handleFile(this)">
          <textarea
            id="msgInput"
            placeholder="Envoyer un messageâ€¦"
            rows="1"
            onkeydown="handleKey(event)"
            oninput="autoResize(this);simTyping()"
          ></textarea>
          <button class="inp-icon-btn" title="Emoji" onclick="toggleEmoji()">ğŸ˜Š</button>
          <button class="send-btn" onclick="sendMessage()">â¤</button>
        </div>
      </div>

      <div class="panel-resize"></div>
    </div>

    <!-- â”€â”€ PANEL: Members â”€â”€ -->
    <div class="panel" id="panel-members" onclick="bringToFront('panel-members')">
      <div class="panel-header">
        <div class="panel-controls">
          <div class="panel-ctrl close"    onclick="closePanel('panel-members')"></div>
          <div class="panel-ctrl minimize" onclick="minimizePanel('panel-members')"></div>
          <div class="panel-ctrl maximize"></div>
        </div>
        <div class="panel-title">Membres</div>
      </div>
      <div class="members-list" id="members-list">
        <!-- rendered by JS -->
      </div>
      <div class="panel-resize"></div>
    </div>

  </div><!-- /desktop -->


  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MOBILE LAYOUT
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="mobile-layout">

    <!-- Mobile topbar -->
    <div class="mob-topbar">
      <div class="mob-logo">Likoo ğŸ’œ</div>
      <button class="mob-btn" onclick="openModal('modal-settings')">âš™</button>
      <button class="mob-btn" onclick="openModal('modal-create-server')">+</button>
    </div>

    <!-- Mobile views -->

    <!-- Servers view -->
    <div class="mob-view active" id="mob-view-servers">
      <div class="mob-servers" id="mob-servers-grid">
        <!-- rendered by JS -->
      </div>
    </div>

    <!-- Channels view -->
    <div class="mob-view" id="mob-view-channels">
      <div class="channels-list mob-channels" id="mob-channels-list" style="flex:1;overflow-y:auto;padding:6px">
        <!-- rendered by JS -->
      </div>
    </div>

    <!-- Chat view -->
    <div class="mob-view" id="mob-view-chat">
      <!-- Chat topbar -->
      <div class="chat-bar" style="background:var(--panel)">
        <button class="chat-bar-btn" onclick="switchMobTab('channels')">â†</button>
        <span id="mob-chat-icon" class="bar-ico">#</span>
        <span id="mob-chat-name" class="ch-label">Chat</span>
      </div>
      <!-- Messages â€” shares same IDs via desktop for simplicity; mobile uses duplicate IDs via JS manipulation -->
      <div class="messages-area" id="mob-messages-area" style="background:var(--bg)"></div>
      <!-- Input -->
      <div class="input-zone" style="position:relative">
        <div class="emoji-picker" id="mob-emoji-picker">
          <div class="emoji-grid" id="mob-emoji-grid"></div>
        </div>
        <div class="input-row">
          <button class="inp-icon-btn" onclick="document.getElementById('mob-file-input').click()">ğŸ“</button>
          <input type="file" id="mob-file-input" style="display:none" onchange="handleMobFile(this)">
          <textarea
            id="mob-msgInput"
            placeholder="Envoyer un messageâ€¦"
            rows="1"
            onkeydown="handleMobKey(event)"
            oninput="autoResize(this)"
          ></textarea>
          <button class="inp-icon-btn" onclick="toggleMobEmoji()">ğŸ˜Š</button>
          <button class="send-btn" onclick="sendMobMessage()">â¤</button>
        </div>
      </div>
    </div>

    <!-- Members view -->
    <div class="mob-view" id="mob-view-members">
      <div class="members-list" id="mob-members-list" style="overflow-y:auto"></div>
    </div>

    <!-- Bottom Nav -->
    <div class="mob-bottomnav">
      <button class="mob-nav-btn active" id="mob-btn-servers" onclick="switchMobTab('servers')">
        ğŸ <span>Serveurs</span>
      </button>
      <button class="mob-nav-btn" id="mob-btn-channels" onclick="switchMobTab('channels')">
        #<span>Salons</span>
      </button>
      <button class="mob-nav-btn" id="mob-btn-chat" onclick="switchMobTab('chat')">
        ğŸ’¬<span>Chat</span>
      </button>
      <button class="mob-nav-btn" id="mob-btn-members" onclick="switchMobTab('members')">
        ğŸ‘¥<span>Membres</span>
      </button>
    </div>

  </div><!-- /mobile-layout -->

</div><!-- /app -->


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Setup -->
<div class="overlay" id="modal-setup">
  <div class="modal">
    <h2>Bienvenue sur Likoo ğŸ’œ</h2>
    <p class="sub">CrÃ©ez votre profil pour rejoindre la communautÃ©.</p>
    <input type="text" id="setupName" placeholder="Ton nom d'affichage" maxlength="32">
    <input type="text" id="setupTag" placeholder="Tag numÃ©rique (4 chiffres)" maxlength="4">
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="setupAccount()">Entrer dans Likoo ğŸš€</button>
    </div>
  </div>
</div>

<!-- Create Server -->
<div class="overlay" id="modal-create-server">
  <div class="modal">
    <h2>CrÃ©er un serveur âœ¨</h2>
    <p class="sub">Donnez un nom et une ambiance Ã  votre communautÃ©.</p>
    <input type="text" id="new-srv-name" placeholder="Nom du serveur" maxlength="32">
    <input type="text" id="new-srv-emoji" placeholder="Emoji (ex: ğŸ® ğŸµ ğŸ¨)" maxlength="2">
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modal-create-server')">Annuler</button>
      <button class="btn btn-primary" onclick="createServer()">CrÃ©er</button>
    </div>
  </div>
</div>

<!-- Create Channel -->
<div class="overlay" id="modal-create-channel">
  <div class="modal">
    <h2>Nouveau salon</h2>
    <p class="sub">Ajoutez un salon Ã  votre serveur.</p>
    <input type="text" id="new-ch-name" placeholder="nom-du-salon" maxlength="32">
    <div class="chip-row">
      <div class="chip sel" data-type="text"     onclick="selectChType(this)">ğŸ’¬ Texte</div>
      <div class="chip"     data-type="voice"    onclick="selectChType(this)">ğŸ”Š Vocal</div>
      <div class="chip"     data-type="announce" onclick="selectChType(this)">ğŸ“¢ Annonces</div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modal-create-channel')">Annuler</button>
      <button class="btn btn-primary" onclick="createChannel()">CrÃ©er</button>
    </div>
  </div>
</div>

<!-- Settings -->
<div class="overlay" id="modal-settings">
  <div class="modal">
    <h2>Mon profil</h2>
    <p class="sub">Modifiez vos informations et prÃ©fÃ©rences.</p>
    <input type="text" id="set-name" placeholder="Nom d'affichage">

    <div style="margin-bottom:10px">
      <div style="font-size:11px;font-weight:800;color:var(--text4);text-transform:uppercase;letter-spacing:1px;margin-bottom:7px">Statut</div>
      <div class="status-chips">
        <div class="st-chip" onclick="setStatus('online')">ğŸŸ¢ En ligne</div>
        <div class="st-chip" onclick="setStatus('away')">ğŸŸ¡ Absent</div>
        <div class="st-chip" onclick="setStatus('dnd')">ğŸ”´ Ne pas dÃ©ranger</div>
        <div class="st-chip" onclick="setStatus('offline')">âš« Invisible</div>
      </div>
    </div>

    <div style="margin-bottom:14px">
      <div style="font-size:11px;font-weight:800;color:var(--text4);text-transform:uppercase;letter-spacing:1px;margin-bottom:7px">Disposition des modules</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-ghost" style="font-size:12px;padding:6px 12px" onclick="resetLayout()">â†© RÃ©initialiser</button>
        <button class="btn btn-ghost" style="font-size:12px;padding:6px 12px" onclick="saveLayout();alert('Disposition sauvegardÃ©e !')">ğŸ’¾ Sauvegarder</button>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modal-settings')">Fermer</button>
      <button class="btn btn-primary" onclick="saveSettings()">Sauvegarder</button>
    </div>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCRIPTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script src="app.js"></script>

<script>
// â”€â”€ Mobile chat helpers â”€â”€
function sendMobMessage() {
  const inp = document.getElementById('mob-msgInput');
  const text = inp ? inp.value.trim() : '';
  const key = activeKey();
  if (!text || !key) return;
  pushMsg(key, { author:{ name:APP.me.name, av:APP.me.av, color:APP.me.color }, content:text });
  inp.value = ''; inp.style.height = '';
  renderMobChat();
}

function handleMobKey(e) { if (e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMobMessage();} }

function handleMobFile(inp) {
  const file = inp.files[0]; if (!file) return;
  const key = activeKey(); if (!key) return;
  const r = new FileReader();
  r.onload = e => {
    pushMsg(key, { author:{name:APP.me.name,av:APP.me.av,color:APP.me.color}, content:'', time:now(), reactions:[],
      file:{name:file.name,type:file.type,size:fmtBytes(file.size),data:e.target.result} });
    renderMobChat();
  };
  r.readAsDataURL(file); inp.value='';
}

function toggleMobEmoji() { document.getElementById('mob-emoji-picker')?.classList.toggle('open'); }

// â”€â”€ Build mobile emoji grid â”€â”€
window.addEventListener('DOMContentLoaded', () => {
  const EMOJIS=['ğŸ˜€','ğŸ˜‚','â¤ï¸','ğŸ‘','ğŸ‰','ğŸ”¥','âœ¨','ğŸ˜','ğŸ¤”','ğŸ˜…','ğŸ‘€','ğŸ’¯','ğŸš€','ğŸ®','ğŸ’œ','ğŸ˜','ğŸ¤£','ğŸ‘‹','ğŸ’ª','ğŸ¦„','âš¡','ğŸŒŸ','ğŸ˜­','ğŸ¥º','ğŸ¤¯'];
  const grid = document.getElementById('mob-emoji-grid');
  if (grid) grid.innerHTML = EMOJIS.map(e=>`<button class="emoji-cell" onclick="insertMobEmoji('${e}')">${e}</button>`).join('');
});

function insertMobEmoji(e) {
  const i = document.getElementById('mob-msgInput'); if(i){i.value+=e;i.focus();}
  document.getElementById('mob-emoji-picker')?.classList.remove('open');
}

// Mobile version of renderChat that targets #mob-messages-area
function renderMobChat() {
  const key = activeKey();
  const msgs = key ? (APP.messages[key]||[]) : [];
  const el = document.getElementById('mob-messages-area');
  if (!el) return;

  // Update topbar
  const icon = document.getElementById('mob-chat-icon');
  const name = document.getElementById('mob-chat-name');
  if (APP.view==='dm' && APP.dmChannel) {
    const u = [{id:'dm_zara',name:'Zara',av:'ğŸ¦Š'},{id:'dm_nino',name:'Nino',av:'ğŸ‘¾'},{id:'dm_lea',name:'LÃ©a',av:'ğŸ¦‹'}].find(d=>d.id===APP.dmChannel);
    if(icon) icon.textContent = u?.av||'ğŸ’¬';
    if(name) name.textContent = u?.name||'MP';
  } else if (APP.activeSrv && APP.activeCh) {
    const ch = APP.activeSrv.channels.find(c=>c.id===APP.activeCh);
    if(icon) icon.textContent = ch?.type==='announce'?'ğŸ“¢':'#';
    if(name) name.textContent = ch?.name||'';
  }

  if (!key || msgs.length===0) {
    el.innerHTML=`<div class="empty-state"><div class="big-emoji">ğŸ’¬</div><h3>DÃ©but</h3><p>Soyez le premier Ã  Ã©crire !</p></div>`;
    return;
  }

  el.innerHTML = msgs.map((m,i)=>{
    if(m.system) return `<div class="sys-line">${m.content}</div>`;
    const prev=msgs[i-1]; const same=prev&&!prev.system&&prev.author?.name===m.author?.name;
    const auth=m.author||APP.me; const isMe=auth.name===APP.me.name;
    const reacts=(m.reactions||[]).map(r=>`<span class="react-chip ${r.mine?'mine':''}" onclick="toggleReact('${key}',${m.id},'${r.e}');renderMobChat()">${r.e} ${r.c}</span>`).join('');
    const body=m.file?(m.file.type.startsWith('image/')?`<img src="${m.file.data}" class="img-preview">`:`<div class="file-chip">ğŸ“„ ${m.file.name}</div>`):`<div class="msg-content">${String(m.content).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>`;
    if(same) return `<div class="msg-wrap"><div style="width:36px;font-size:10px;color:var(--text4);text-align:center;flex-shrink:0">${m.time}</div><div class="msg-body">${body}<div class="react-row">${reacts}</div></div></div>`;
    return `<div class="msg-wrap">
      <div class="msg-avatar" style="background:${auth.color}22">${auth.av||auth.avatar}</div>
      <div class="msg-body"><div class="msg-meta"><span class="msg-author" style="color:${auth.color}">${auth.name}</span><span class="msg-time">${m.time}</span></div>${body}<div class="react-row">${reacts}</div></div>
    </div>`;
  }).join('');
  setTimeout(()=>el.scrollTop=el.scrollHeight,50);
}

// Patch selectChannel & selectDM to also update mobile chat
const _origSelectChannel = selectChannel;
const _origSelectDM = selectDM;

// Override renderChat to also call renderMobChat
const _origRenderChat = renderChat;
window.renderChat = function() {
  _origRenderChat();
  if (APP.isMobile) renderMobChat();
};

// â”€â”€ Reset layout â”€â”€
function resetLayout() {
  localStorage.removeItem('likoo_layout');
  const defaults = {
    'panel-servers':  { left:'12px',  top:'12px',  width:'72px',               height:'calc(100vh - 24px)' },
    'panel-channels': { left:'96px',  top:'12px',  width:'220px',              height:'calc(100vh - 24px)' },
    'panel-chat':     { left:'328px', top:'12px',  width:'calc(100vw - 628px)', height:'calc(100vh - 24px)' },
    'panel-members':  { right:'12px', top:'12px',  width:'200px',              height:'calc(100vh - 24px)' },
  };
  Object.entries(defaults).forEach(([id,pos]) => {
    const p = document.getElementById(id);
    if (!p) return;
    Object.assign(p.style, pos);
    p.style.display = 'flex';
  });
}
</script>

</body>
</html>
